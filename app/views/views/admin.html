<!DOCTYPE html>
<html lang="en">
	<head>
    	{% include path.head %}
	</head>
    <body>
        {% include path.scaffolding %}
		<div id="content">
			<module>
				<flash class="box-std">
					{% include path.flash %}
				</flash>
			</module>
			<module>
				<part class="tabs">
					<ul class="wrap box-std">
						<li data-tab="0" class="tab">SQL</li>
						<li data-tab="1" class="tab">UAC</li>
						<li data-tab="2" class="tab">Toggles</li>
						<li data-tab="3" class="tab">Backup</li>
						<li data-tab="4" class="tab">Notifications</li>
					</ul>
				</part>
				<part class="obj">
					<box data-obj="0" class="tabobj box-std">
						<part class="wrap container">
							<input type="text" class="prompt" placeholder="SQL" />
						</part>
						<part class="wrap container-bottom">
							<a event class="left" style="cursor: pointer">Events</a>
							<a clear-event class="right" style="cursor: pointer;">Clear events</a>
						</part>
						<part class="output" style="display: none;">
							<hr>
							<part class="container">
								<div insights>
								</div>
							</part>
							<hr>
							<part class="container">
								<div console>
								</div>
							</part>
						</part>
					</box>
					<box data-obj="1" class="tabobj box-std">
						<part class="wrap container" style="width: 270px;">
							<div class="h3 title">
								Generate Password
							</div>
							<input type="text" class="left" pw style="height: 37px;">
							<button pw-get class="button left" style="margin-left: 5px;">GET</button>
						</part>
						<part class="container">
							<div pw-console>
							</div>
						</part>
					</box>
					<box data-obj="2" class="tabobj box-std">
						<part class="container" style="padding: 30px 15px;">
							<table class="toggle-table">
								<tbody>
									{% for a,b in env %}
									<tr>
										<td>{{a}}</td>
										<td>
											{% if b %}
											<img src="{{path.root}}/css/media/toggle-on.png" data-name="{{a}}" data-value="{{b}}" height="26" />
											{% else %}
											<img src="{{path.root}}/css/media/toggle-off.png" data-name="{{a}}" data-value="{{b}}" height="26" />
											{% endif %}
										</td>
									</tr>
									{% endfor %}
								</tbody>
							</table>
						</part>
					</box>
					<box data-obj="3" class="tabobj box-std">
						<part class="container" style="padding: 30px 15px;">
							<button pw-backup class="button">
								BACKUP
							</button>
						</part>
					</box>
					<box data-obj="4" class="tabobj box-std">
						<part class="container" style="padding: 30px;">
							<table class="new-notification">
								<tbody>
									<tr>
										<td>user_id</td>
										<td><input type="text" name="user_id" placeholder="1,2,3 || All, all, *" required></td>
									</tr>
									<tr>
										<td>Text</td>
										<td><input type="text" name="text" placeholder="What arm thing homie?" required></td>
									</tr>
									<tr>
										<td>Page</td>
										<td><input type="text" name="page" placeholder="jobs" required></td>
									</tr>
									<tr>
										<td>Anchor</td>
										<td><input type="text" name="anchor" placeholder=".box" required></td>
									</tr>
									<tr>
										<td>Position</td>
										<td><input type="text" name="position" placeholder="right-center" required></td>
									</tr>
									<tr>
										<td>Commands</td>
										<td><input type="text" name="commands" placeholder="command, command" required></td>
									</tr>
									<tr>
										<td></td>
										<td style="height:40px">
											<button class="button notification-post" style="margin-top:3px">POST</button>
										</td>
									</tr>
								</tbody>
							</table>
						</part>
					</box>
				</div>
			</part>
		</module>
		<script>
		var environment = {
			root: '{{path.root}}',
			page: '{{path.page}}',
		};
		</script>
		{% include path.js with {
			include: ['Tab', 'sweetalert', 'Validation']
		}%}
		<script>
			$(function(){
				
				new Tab({
					cookie: {
						name: 'admin'
					}
				});
				
				var v = new Validation;
				
				var landing = 0;
				var regist = 0;
				var newuser = 0;
				var playcount = 0;
				
				function dump(obj) {
					var out = '';
					for (var i in obj) {
						out += i + ": " + obj[i] + "\n";
					}
					
					if(out.indexOf('landing page') !== -1){
						landing++;
					}else if(out.indexOf('registration page') !== -1){
						regist++;
					}else if(out.indexOf('registered with username') !== -1){
						newuser++;
					}else if(out.indexOf('played the') !== -1){
						playcount++;
					}
					
					$('[insights]').html(
						'Landing Page: '+landing+
						'<br>Video play count: '+playcount+
						'<br>Registration Page: '+regist+
						'<br>New Users: '+newuser
					);
					
					if(out.indexOf('landing') == -1){
						$('[console]').append(
							'<pre>'+
								out+
							'</pre>'
						);
					}
				}
				
				$('[event]').on('click', function(){
					var q = 'SELECT * FROM event WHERE user_id<>1 ORDER BY id DESC';
					
					$('[console]').html('');
					landing = regist = newuser = playcount = 0;
					
					$.post('{{path.root}}/admin/post/query', {
						'query': q
					}).done(function(data){
						if(data = JSON.parse(data)){
							$.each(data, function(y,z){
								dump(z);
							});
							$('.prompt').val('');
							if(data.length > 1) $('.output').show();
						}
					});
				});
				
				$('[clear-event]').on('click', function(){
					var q = 'DELETE from event';
					
					$.post('{{path.root}}/admin/post/query', {
						'query': q
					}).done(function(data){
						if(data = JSON.parse(data)){
							$('[console]').html('');
							$.each(data, function(y,z){
								dump(z);
							});
							$('.prompt').val('');
							$('.output').hide();
						}
					});
				});
				
				$('.prompt').on('keydown', function(e){
					if(e.keyCode == 13){
						q = $(this).val();
						if(q == 'clear'){
							$('[console]').html('');
							$(this).val('');
						}else if(q != ''){
							$('[console]').html('');
							
							if(q.toUpperCase() == 'users'.toUpperCase()) q = 'SELECT * FROM user ORDER BY user_id DESC';
							if(q.toUpperCase() == 'event'.toUpperCase()) q = 'SELECT * FROM event WHERE user_id<>1 ORDER BY id DESC';
							if(q.toUpperCase() == 'clear event'.toUpperCase()) q = 'TRUNCATE event';
							
							$.post('{{path.root}}/admin/post/query', {
								'query': q
							}).done(function(data){
								if(data = JSON.parse(data)){
									$.each(data, function(y,z){
										dump(z);
									});
									$('.prompt').val('');
								}
							});
						}
					}
				});
				
				$('[pw-get]').on('click', function(){
					p = $('[pw]').val();
					$.post('{{path.root}}/admin/get/password', {
						pw: p
					}).done(function(data){
						$('[pw-console]').html('');
						$('[pw-console]').html(data);
					});
				});
				
				// Config toggles
				$('.toggle-table img').on('click', function(){
					var name = $(this).attr('data-name'),
						value = $(this).attr('data-value'),
						ele = $(this),
						src = null;
					
					$(this).addClass('fade');
					
					$.post('{{path.root}}/admin/post/config', {
						name: name
					}).done(function(data){
						if(data == 'Success'){
							if(value == 0){
								src = '{{path.root}}/css/media/toggle-on.png';
								value = 1;
							}else{
								src = '{{path.root}}/css/media/toggle-off.png';
								value = 0;
							}
							ele.attr('src', src);
							ele.attr('data-value', value);
							ele.removeClass('fade');
						}else{
							console.log(data);
						}
					});
				});
				
				// SQLBackup
				$('[pw-backup]').on('click', function(){
					var button = $(this);
					
					Paperwork.wait(button);
					$.post('{{path.root}}/admin/post/backup')
					.done(function(data){
						if(data == 'Success') Paperwork.ready(button, 'BACKUP');
					});
				});
				
				// Notification
				v.input($('.new-notification'), $('.notification-post'), 'notification', {
					allowDuplicates: true
				});
				$('.notification-post').on('click', function(){
					var $notification = $('.new-notification');
					var user_id = $notification.find('[name="user_id"]').val();
					if(user_id == 'all' || user_id == '*' || user_id == 'All'){
						user_id = '*';
					}else{
						user_id = user_id.split(',');
					}
					
					user_id = JSON.stringify(user_id);
					
					$.post(environment.root+'/admin/post/notification', {
						user_id: user_id,
						page: $notification.find('[name="page"]').val().trim(),
						text: $notification.find('[name="text"]').val().trim(),
						anchor: $notification.find('[name="anchor"]').val().trim(),
						position: $notification.find('[name="position"]').val().trim(),
						commands: $notification.find('[name="commands"]').val().trim(),
					}).done(function(data){
						if(data == 'success'){
							alert('Success');
						}else{
							console.log(data);
							alert('Notification post failed');
						}
					}).fail(function(data){
						console.log(data);
						alert('Notification post failed');
					})
					
				});
				
				{% include path.load %}
			});
		</script>
    </body>
</html>