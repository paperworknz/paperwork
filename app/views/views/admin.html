<!DOCTYPE html>
<html lang="en">
	<head>
    	{% include head %}
	</head>
    <body>
        {% include menu %}
		<div id="content">
			<flash data-module="flash" class="box-std">{% include path.html.flash %}</flash>
			<module data-module="admin">
				{% include 'other/modules/admin.html' %}
			</module>
		{% include js %}
		<script>
			$(function(){
				
				var landing = 0;
				var regist = 0;
				var newuser = 0;
				
				function dump(obj) {
					var out = '';
					var id;
					for(var i in obj){
						out += i + ": " + obj[i] + "\n";
						
						if(i == 'user_id') id = obj[i];
					}
					
					if(out.indexOf('Welcome email') !== -1){
						newuser++;
					}
					
					$('[insights]').html(
						'New Users: '+newuser
					);
					
					out = out.replace('user_id: '+id, 'user_id: <a href="{{environment.root}}/user/'+id+'">'+id+'</a>');
					
					if(out.indexOf('page with IP') == -1){
						$('[console]').append(
							'<pre>'+
								out+
							'</pre>'
						);
					}
					
					$('.output').show();
				}
				
				$('[event]').on('click', function(){
					var q = 'SELECT * FROM event WHERE user_id<>1 ORDER BY id DESC';
					
					$('[console]').html('');
					landing = regist = newuser = guestcount = 0;
					
					$.post('{{environment.root}}/admin/post/query', {
						'query': q
					}).done(function(data){
						if(data = JSON.parse(data)){
							$.each(data, function(y,z){
								dump(z);
							});
							$('.prompt').val('');
							if(data.length > 1) $('.output').show();
						}
					});
				});
				
				$('[clear-event]').on('click', function(){
					var q = 'DELETE from event';
					
					$.post('{{environment.root}}/admin/post/query', {
						'query': q
					}).done(function(data){
						if(data = JSON.parse(data)){
							$('[console]').html('');
							$.each(data, function(y,z){
								dump(z);
							});
							$('.prompt').val('');
							$('.output').hide();
						}
					});
				});
				
				$('.prompt').on('keydown', function(e){
					if(e.keyCode == 13){
						q = $(this).val();
						if(q == 'clear'){
							$('[console]').html('');
							$(this).val('');
						}else if(q != ''){
							$('[console]').html('');
							
							if(q.toUpperCase() == 'users'.toUpperCase()) q = 'SELECT * FROM user ORDER BY user_id DESC';
							if(q.toUpperCase() == 'event'.toUpperCase()) q = 'SELECT * FROM event WHERE user_id<>1 ORDER BY id DESC';
							if(q.toUpperCase() == 'clear event'.toUpperCase()) q = 'TRUNCATE event';
							
							$.post('{{environment.root}}/admin/post/query', {
								'query': q
							}).done(function(data){
								if(data = JSON.parse(data)){
									$.each(data, function(y,z){
										dump(z);
									});
									$('.prompt').val('');
								}
							});
						}
					}
				});
				
				$('[pw-get]').on('click', function(){
					p = $('[pw]').val();
					$.post('{{environment.root}}/admin/get/password', {
						pw: p
					}).done(function(data){
						Paperwork.ready($('[pw-get]'), 'GET');
						$('[pw-console]').html('');
						$('[pw-console]').html(data);
					});
				});
				
				// Config toggles
				$('.toggle-table img').on('click', function(){
					var name = $(this).attr('data-name'),
						value = $(this).attr('data-value'),
						ele = $(this),
						src = null;
					
					$(this).addClass('fade');
					
					$.post('{{environment.root}}/admin/post/config', {
						name: name
					}).done(function(data){
						if(data == 'Success'){
							if(value == 0){
								src = '{{environment.root}}/css/media/toggle-on.png';
								value = 1;
							}else{
								src = '{{environment.root}}/css/media/toggle-off.png';
								value = 0;
							}
							ele.attr('src', src);
							ele.attr('data-value', value);
							ele.removeClass('fade');
						}else{
							console.log(data);
						}
					});
				});
				
				// SQLBackup
				$('[pw-backup]').on('click', function(){
					var button = $(this);
					
					$('[backup-console]').html('');
					$.post('{{environment.root}}/admin/post/backup')
					.done(function(data){
						data = JSON.parse(data);
						
						Paperwork.ready(button, 'BACKUP');
						if(data.type == 'success'){
							$('[backup-console]').html(data.message);
						}else{
							$('[backup-console]').html(data.message);
						}
					});
				});
				
				// Tour
				// v.input($('.new-tour'), $('.tour-post'), 'tour', {
				// 	allowDuplicates: true
				// });
				
				// Commands
				var commands = ['event', 'return', 'href', 'chain', ],
					$commands = $('.commands'),
					$ckey = $commands.find('select');
				
				commands.forEach(function(value, index, array){
					$ckey.append('<option value="' + value + '">' + value + '</option>');
				});
				
				$ckey.on('change', function(){
					var value = $(this).val(),
						$newc = $commands.find('.new-command'),
						placeholder = '';
					
					if(value){
						switch(value){
							case 'return': placeholder = 'anchor | item'; break;
							case 'href': placeholder = '/page'; break;
							case 'chain': placeholder = 'true | false'; break;
							case 'event':
								$newc.before(
									'<div class="wrap commands-event">'+
										'<input type="text" class="commands-width" style="text-align: right;" name="key" placeholder="Event Name" />'+
										' : '+
										'<input type="text" class="commands-width" name="value" placeholder="Data" />'+
									'</div>'
								);
								
								$(this).val('');
								return;
								break;
						}
						
						$newc.before(
							'<div class="wrap">'+
								'<div class="left commands-print">'+
									value+
								'</div>'+
								'<div class="left commands-colon">:</div>'+
								'<div class="left commands-width">'+
									'<input type="text" class="commands-value" data-command="' + value + '" placeholder="' + placeholder + '"/>'+
								'</div>'+
							'</div>'
						);
						
						$(this).find('option[value="' + value + '"]').remove();
						$(this).val('');
						
						if($(this).find('option').length === 1) $newc.remove();
					}
				});
				
				$('.tour-post').on('click', function(){
					var $tour = $('.new-tour');
					var $button = $(this);
					var user_id = $tour.find('[name="user_id"]').val();
					if(user_id == 'all' || user_id == '*' || user_id == 'All'){
						user_id = '*';
					}else{
						user_id = user_id.split(',');
					}
					
					user_id = JSON.stringify(user_id);
					
					var commands = {};
					$('.commands-value').each(function(){
						var index = $(this).attr('data-command'),
							value = $(this).val();
						
						if(value) commands[index] = value;
					});
					
					$('.commands-event').each(function(){
						var index = $(this).find('input[name="key"]').val().trim(),
							value = $(this).find('input[name="value"]').val().trim();
						
						if(index && value) commands['e.' + index] = value;
					});
					
					commands = JSON.stringify(commands);
					
					$.post(environment.root+'/admin/post/tour', {
						user_id: user_id,
						page: $tour.find('[name="page"]').val().trim(),
						text: $tour.find('[name="text"]').val().trim(),
						anchor: $tour.find('[name="anchor"]').val().trim(),
						position: $tour.find('[name="position"]').val().trim(),
						commands: commands,
					}).done(function(data){
						if(data == 'success'){
							Paperwork.send('notification', 'Saved');
							Paperwork.ready($button, 'POST');
						}else{
							console.log(data);
							alert('Tour post failed');
							Paperwork.ready($button, 'POST');
						}
					}).fail(function(data){
						console.log(data);
						alert('Tour post failed');
						Paperwork.ready($button, 'POST');
					});
				});
				
				
			});
		</script>
    </body>
</html>