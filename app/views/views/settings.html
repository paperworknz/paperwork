<!DOCTYPE html>
<html lang="en">
	<head>
    	{% include path.head %}
	</head>
    <body>
        {% include path.scaffolding %}
        <div id="content" style="display:none;">
			{% include path.flash %}
			<div class="tabs">
				<ul class="wrapper">
					<li data-tab="0" class="tab noselect">My Account</li>
					<li data-tab="1" class="tab noselect">Job Config</li>
					<li data-tab="2" class="tab noselect">Email</li>
					<li data-tab="3" class="tab noselect">Trash</li>
				</ul>
			</div>
			<div class="obj">
				<div data-obj="0" class="box material im" style="padding:10px 30px 30px">
					<div class="h4">My Details</div>
					<div class="uac">
						<form method="post" action="{{path.root}}/put/settings">
							<table class="user-details">
								<tbody>
									<tr>
										<td>First</td>
										<td><input type="text" name="first" value="{{user.first}}" required></td>
									</tr>
									<tr>
										<td>Last</td>
										<td><input type="text" name="last" value="{{user.last}}"></td>
									</tr>
									<tr>
										<td>Email</td>
										<td><input type="text" name="email" type="email" value="{{user.email}}" required></td>
									</tr>
									<tr>
										<td>Company</td>
										<td><input type="text" name="company" value="{{user.company}}" required></td>
									</tr>
									<tr>
										<td>Phone</td>
										<td><input type="text" name="phone" value="{{user.phone}}"></td>
									</tr>
									<tr>
										<td></td>
										<td style="height:40px">
											<button class="wolfe-btn" style="margin-top:3px">UPDATE</button>
										</td>
									</tr>
								</tbody>
							</table>
						</form>
						<hr>
						<form method="post" action="{{path.root}}/put/password">
							<table class="password-settings">
								<tbody>
									<tr>
										<td>Password</td>
										<td><input name="oldpw" type="password" placeholder="Old Password" required></td>
									</tr>
									<tr>
										<td></td>
										<td><input name="newpw" type="password" placeholder="New Password" required></td>
									</tr>
									<tr>
										<td></td>
										<td><input name="confirmpw" type="password" placeholder="Confirm New Password" required></td>
									</tr>
									<tr>
										<td></td>
										<td style="height:40px">
											<input type="hidden" name="my">
											<button class="wolfe-btn" style="margin-top:3px">UPDATE</button>
										</td>
									</tr>
								</tbody>
							</table>
						</form>
					</div>
				</div>
				<div data-obj="1" class="box material im" style="padding:10px 30px 30px">
					<div class="jobstatus">
						<div class="h4">Job Statuses</div>
						<ul id="jobstatus" class="kappa">
							{% for item in status %}
							<li>
								<div style="position:relative;width:180px;">
									<input type="text" data-id="{{item.id}}" value="{{item.name}}" style="padding-right:24px;width:100%" 
									{% if item.name == 'Completed' %}
									disabled title="This is currently a built-in status"
									{% endif %}
									/>
									<div class="status-handle">::</div>
								</div>
							</li>
							{% endfor %}
						</ul>
						<a style="cursor:pointer;" new-status>
							{% if status is empty %}
							New Status
							{% else %}
							Another One
							{% endif %}
						</a><br>
						<button class="wolfe-btn" style="margin-top:7px;" job-status-btn>UPDATE</button>
					</div>
					<hr>
					<div class="h4">Change Next Job Number</div>
					<div class="job_number">
						<form method="post" action="{{path.root}}/post/job-number">
							Next Job Number <input type="text" name="job_number" value="{{job_number}}" required><br>
							<button class="wolfe-btn" style="margin-top:7px;">UPDATE</button>
						</form>
					</div>
					<!--<hr>
					<a href="{{path.root}}/register-settings">Rename your templates</a>-->
				</div>
				<div data-obj="2" class="box material im" style="padding:10px 30px 30px">
					<form method="post" action="{{path.root}}/put/email-settings">
						<div class="h4">Email Integration</div>
						{% if email != true %}
						<div class="alert alert-success">
							For Paperwork to send emails on your behalf, you may need to change some email settings with your email provider.<br><br>
							For Gmail, please follow <a href="https://www.google.com/settings/security/lesssecureapps" target="_blank"><b>this link</b></a>. Otherwise, you will need to ask your email provider how to allow "less secure apps" 
							to use their SMTP server.<br><br>You can always try enter your email and password below, then try to send an email from a <a href="{{path.root}}/jobs"><b>job</b></a> to see if it works.
						</div>
						{% endif %}
						<hr>
						<table class="email-settings">
							<tbody>
								<tr>
									<td>Email</td>
									<td><input class="email-address" type="email" name="address" value="{{email.address}}" placeholder="hello@domain.com" required></td>
								</tr>
								<tr>
									<td>Password</td>
									<td><input type="password" name="password" placeholder="Email Password" value="" required></td>
								</tr>
								<tr>
									<td></td>
									<td><hr></td>
								</tr>
								<tr>
									<td>SMTP</td>
									<td><input type="text" name="smtp" value="{{email.smtp}}" placeholder="smtp.domain.com" required></td>
								</tr>
								<tr>
									<td>Protocol</td>
									<td><input type="text" name="protocol" value="{{email.protocol}}" placeholder="Protocol"></td>
								</tr>
								<tr>
									<td>Port</td>
									<td><input type="text" name="port" value="{{email.port}}" placeholder="000" required></td>
								</tr>
								<tr>
									<td></td>
									<td style="height:40px">
										<button class="wolfe-btn" style="margin-top:3px">UPDATE</button>
									</td>
								</tr>
							</tbody>
						</table>
					</form>
					<hr>
					<table class="email-signature">
						<tbody>
							<tr>
								<td style="vertical-align:top;padding-top:6px;">Signature</td>
								<td>
									<div class="signature" contenteditable>{{email.signature|raw}}</div>
								</td>
							</tr>
							<tr>
								<td></td>
								<td style="height:40px">
									<button class="wolfe-btn" style="margin-top:3px">UPDATE</button>
								</td>
							</tr>
						</tbody>
					</table>
				</div>
				<div data-obj="3" class="box material im" style="padding:30px">
					<div class="trash">
						{% if (jobs is not empty) or (forms is not empty) or (clients is not empty) or (inventory is not empty) %}
						<div class="h4">Jobs</div>
						{% for job in jobs %}
						<div>{{job.job_number}} - {{job.name}} - <span style="color:#999">{{job.client.name}}</span>&nbsp&nbsp<a href="#" data-jobid="{{job.id}}">Undo</a></div>
						{% endfor %}
						<hr>
						<div class="h4">Job Forms</div>
						{% for form in forms %}
						<div>{{form.job.job_number}} - {{form.name}} - <span style="color:#999">{{form.client.name}}</span>&nbsp&nbsp<a href="#" data-formid="{{form.id}}">Undo</a></div>
						{% endfor %}
						<hr>
						<div class="h4">Clients</div>
						{% for client in clients %}
						<div>{{client.client_number}} - {{client.name}}&nbsp&nbsp<a href="#" data-clientid="{{client.id}}">Undo</a></div>
						{% endfor %}
						<hr>
						<div class="h4">Inventory</div>
						{% for item in inventory %}
						<div>{{item.name}} - {{item.price}}&nbsp&nbsp<a href="#" data-inventoryid="{{item.id}}">Undo</a></div>
						{% endfor %}
						<hr>
						<div class="ac empty">Empty Trash</div>
						<div class="ac"><i>Items older than 30 days will be cleaned automatically</i></div>
						{% else %}
						<div class="ac h3">Trash is empty</div>
						{% endif %}
					</div>
				</div>
			</div>
		</div>
		{% include path.js with {
			include: ['Tab', 'Validation', 'sortable']
		}%}
		<script>
			$(function(){
				new Paperwork;
				new Tab({
					cookie: {
						name: 'settings',
						value: '{{user.first}}'
					}
				});
				
				// STATUS REARRANGE //
				new Sortable(document.getElementById('jobstatus'), {
					handle: '.status-handle',
					animation: 150,
					ghostClass: 'status-hover',
				});
				
				// VALIDATION //
				var v = new Validation;
				v.input($('.user-details'), $('.user-details button'), 'user', {
					allowDuplicates: true,
					visible: true,
				});
				v.input($('.email-settings'), $('.email-settings button'), 'email');
				v.input($('.password-settings'), $('.password-settings button'), 'password', {
					allowDuplicates: true
				});
				v.input($('.job_number'), $('.job_number button'), 'jobNumber');
				
				var j = $('.jobstatus ul');
				$('[new-status]').click(function(){
					j.append('<li><input type="text" placeholder="Status name" /></li>');
				});
				
				$('[job-status-btn]').click(function(){
					k = [];
					j.find('input').each(function(){
						if($(this).data('id') != undefined){
							if($(this).val() != undefined){
								k.push({
									id: $(this).data('id'),
									name: $(this).val(),
								});
							}
						}else if($(this).val() != undefined){
							k.push({
								name: $(this).val()
							});
						}
					});
					$.post('{{path.root}}/post/status', {
						data: k
					}).done(function(){
						location.reload();
					});
				});
				
				$('.trash').on('click', 'a', function(){
					rmv($(this));
				});
				
				$('.empty').on('click', function(){
					$('.trash').addClass('no-click');
					$('.trash').css('opacity', '0.5');
					
					$.post('{{path.root}}/post/empty-trash')
					.done(function(data){
						location.reload();
					});
				});
				
				rmv = function(element, callback){
					var type = id = 0;
					$('.trash').addClass('no-click');
					$('.trash').css('opacity', '0.5');
					if(element.attr('data-jobid') != undefined){
						type = 'job',
						id = element.attr('data-jobid');
					}
					if(element.attr('data-formid') != undefined){
						type = 'form',
						id = element.attr('data-formid');
					}
					if(element.attr('data-clientid') != undefined){
						type = 'client',
						id = element.attr('data-clientid');
					}
					if(element.attr('data-inventoryid') != undefined){
						type = 'inventory',
						id = element.attr('data-inventoryid');
					}
					
					$.post('{{path.root}}/put/restore', {
						type: type,
						id: id
					}).done(function(data){
						element.parent().remove();
						$('.trash').removeClass('no-click');
						callback === undefined ? location.reload() : callback();
					});
				};
				
				// EMAIL SETTINGS //
				$('.email-address').on('blur', function(){
					var address = $(this).val(),
						smtp = $('.email-settings input[name=smtp]'),
						protocol = $('.email-settings input[name=protocol]'),
						port = $('.email-settings input[name=port]');
					
					if(address.indexOf('@gmail') != -1){
						smtp.val('smtp.gmail.com');
						protocol.val('TLS');
						port.val('587');
					}
					
					if(address.indexOf('@hotmail') != -1 || address.indexOf('@live') != -1){
						smtp.val('smtp.live.com');
						protocol.val('');
						port.val('465');
					}
					
					if(address.indexOf('@outlook') != -1){
						smtp.val('smtp-mail.outlook.com');
						protocol.val('TLS');
						port.val('587');
					}
					
				});
				
				$('.email-signature button').on('click', function(){
					$.post('{{path.root}}/put/email-signature', {
						signature: $('.signature').html()
					}).done(function(){
						location.reload();
					});
				});
				
			});
		</script>
		{% include path.load %}
    </body>
</html>