var Form=function(){var t=this;t.pw=pw,t.tab=tab,t.p=new Painter,t.s="."+t.tab.activeObj,t.form="[form-blob]",t.map={},$.get(environment.root+"/get/inv",function(i){$.get(environment.root+"/get/form/"+environment.job_id,function(e){var n=[],a=JSON.parse(e);$.each(a,function(t,i){$.each(i.items,function(i,e){void 0!=e.margin&&0!=e.margin||(a[t].items[i].margin="1")})}),t.inv=JSON.parse(i),$.each(t.inv,function(t,i){n.push(t)}),t.typeahead=new Typeahead(n),$(t.form).each(function(){var i=$(this),e=i.attr("data-formid");void 0!=a[e]||null!=a[e]?t.map[e]=a[e]:t.crawl(i),t.construct(i)})})})};Form.prototype.append=function(t,i,e,n){var a=this,i=void 0!==i?i:"",e=void 0!==e?e:"",n=void 0!==n?n:"",o=($(t).attr("data-formid"),a.p.get("latest-item-id",t)),r=!1;void 0===o&&(o=0),o=Number(o)+1,a.inv[i]&&""===n&&(n=r=a.inv[i]),i||(i=n=""),"0.00"==n&&(n=""),a.p.append(t,{itemID:o,item:i,quantity:e,price:n}),13==event.which&&event.preventDefault(),r===!1&&void 0!=i&&swal({html:!0,title:"Add "+i+" to your inventory?",text:"If you save this item you can use it again in future.",showCancelButton:!0,closeOnConfirm:!0,cancelButtonText:"No",confirmButtonText:"Yes"},function(){$.post(environment.root+"/post/inv",{name:i,price:"0.00"})}),$(".typeahead").typeahead("val",""),a.p["do"]("focus-last-item-quantity",t),a.update(t)},Form.prototype.construct=function(t){var i=this,e=t.attr("data-formid");i.refresh(t),$.each(i.map[e].items,function(e,n){i.p.append(t,{itemID:n.itemID,item:n.item,quantity:n.quantity,price:n.price})}),i.update(t),t.css("pointer-events","auto"),t.animate({opacity:1},500)},Form.prototype.crawl=function(t){var i=this,e=t.attr("data-formid"),n={};void 0!=i.map[e]&&$.each(i.map[e].items,function(t,i){void 0!==i.margin||0==i.margin?n[t]=i.margin:n[t]="1"}),i.map[e]={items:{},subtotal:0,tax:0,total:0},i.p.each("item",t,function(t){void 0===i.map[e].items[t.itemID]&&(i.map[e].items[t.itemID]={}),i.map[e].items[t.itemID].itemID=t.itemID,i.map[e].items[t.itemID].item=t.item,i.map[e].items[t.itemID].quantity=t.quantity,i.map[e].items[t.itemID].price=t.price,i.map[e].items[t.itemID].total=t.total,void 0!=n[t.itemID]&&(i.map[e].items[t.itemID].margin=n[t.itemID])}),i.map[e].subtotal=i.p.get("subtotal",t),i.map[e].tax=i.p.get("tax",t),i.map[e].total=i.p.get("total",t)},Form.prototype.dark=function(t){t.off().unbind()},Form.prototype.populate=function(t,i){var e=this;e.p.set("date",t,i.date),e.p.set("jobID",t,i.job_number),e.p.set("client",t,i.client)},Form.prototype.refresh=function(t){var i=this;i.dark(t),$(i.tab.objParent).on("change",function(){i.update(t)}),i.p.on("qty",$(i.tab.objParent),"input",function(){i.update(t)}),i.p.on("price",$(i.tab.objParent),"blur",function(){i.update(t)}),i.p.on("price",$(i.tab.objParent),"input",function(t){13==t.event.keyCode&&(t.event.preventDefault(),t.element.blur())}),t.on("click",".twig-remove",function(){i.p["do"]("this-remove-item",$(this)),i.update(t)}),i.p.initialiseTypeahead(t,function(){i.typeahead.run(t)}),t.bind("typeahead:select",".typeahead",function(){return 13==event.which?void 0:void i.append(t,$(i.s).find(".tt-input").val())}),t.on("keydown",".typeahead",function(){13==event.which&&i.append(t,$(i.s).find(".tt-input").val())});var e=$("."+i.tab.activeTab).attr(i.tab.tabhook),n=$("."+i.tab.activeTab).html();t.closest("."+i.tab.obj).find("[form-pdf-name]").val(e+"-"+n.toLowerCase())},Form.prototype.strip=function(t){var i=this,e=t.clone();return e=i.p.strip(e),e.html()},Form.prototype.update=function(t){var i=this,e=$(t).attr("data-formid"),n=0,a=function(t){return t.toFixed(2)},o=function(t){return t.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")};i.p.each("item",t,function(r){var p=r.itemID,d=(r.name,r.quantity.replace(",","")),m=r.price.replace("$","").replace(",",""),c=a(Number(m)),l=a(Number(d)*c);n+=Number(l),m=c>0?c:m,i.p["do"]("price-by-ID",t,{itemID:p,val:"$"+o(m)}),i.p["do"]("total-by-ID",t,{itemID:p,val:"$"+o(l)}),void 0!=i.map[e].items[p]&&m!=i.map[e].items[p].price.replace("$","").replace(",","")&&0==$("[margin]").length&&(i.map[e].items[p].margin=1)});var r=a(n),p=a(3*n/2/10),d=a(Number(r)+Number(p));i.p.set("subtotal",t,"$"+o(r)),i.p.set("tax",t,"$"+o(p)),i.p.set("total",t,"$"+o(d)),i.crawl(t),void 0!=i.p.update&&i.p.update(t)},Form.prototype.copy=function(t){var i=this,e=t.attr("data-formid");swal({title:"Choose your template",text:"1 for Quote, 2 for Invoice",type:"input",inputPlaceholder:"Write something",showCancelButton:!0,html:!0},function(n){if(0!=n){var a=$(this),o=n,r="Invoice";r=1==o?"Quote":"Invoice";var p={client:i.p.get("client",t),jobd:i.p.get("jobd",t),content:i.map[e]};pw.wait(a),i.post({url:environment.root+"/post/form",template_id:o,template_name:r,client_id:environment.client_id,job_id:environment.job_id},function(t){$.each(i.map[e].items,function(e,n){i.p.append(t,{itemID:n.itemID,item:n.item,quantity:n.quantity,price:n.price})});var n=t.attr("data-formid");i.p.set("client",t,p.client),i.p.set("jobd",t,p.jobd),i.construct(t),i.put({url:environment.root+"/put/form",id:n},function(){pw.ready(a,"COPY")})})}})},Form.prototype.pdf=function(t,i){var e=this,n=t.clone();n=e.strip(n);var a="<!DOCTYPE html><html lang='en'><head><meta name='viewport' content='width=device-width,initial-scale=1.0'><link rel='stylesheet' href='https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css' type='text/css'></head><body>"+n+"</body>";i(a)},Form.prototype.margin=function(t){var i=this,e=t.attr("data-formid"),n=(i.p.get("remove"),{}),a=i.p.get("item-price"),o=t.find($(i.p.get("form-content",t))),r=function(t){return t.toFixed(2)},p=function(t){return t.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")};$.each(i.map[e].items,function(t,i){var e=t,a=i.margin;n[e]={current:i.price,original:Number(i.price.replace("$","").replace(",",""))/a}}),i.dark(t),$("#content").after("<div margin></div>"),$("[margin]").append('<div fade style="width:10000px;height:10000px;background-color:black;opacity:0.0;position:fixed;top:0;z-index:2;overflow:hidden;" disable></div>'),$("[fade]").after("<div margin-content></div>"),$("[margin-content]").css({position:"absolute","z-index":999,top:o.offset().top-51,left:o.offset().left-30,width:"710px","background-color":"white",border:"none","min-height":"50px",opacity:"0.00"}),$("[margin-content]").html("<div margin-parent></div>"),$("[margin-parent]").css({margin:"10px",border:"1px solid black"}),$.each(i.map[e].items,function(t,i){$("[margin-parent]").append('<div class="margin-item wrapper lowlight" item-id="'+t+'"><input type="checkbox" style="float:left;margin-left:5px"><div style="float:left;width:285px;overflow:hidden;white-space:nowrap;position:relative;margin-left:5px;margin-right:10px;height:24px;line-height:24px">'+i.item+'</div><div margin-qty style="float:left;width:50px;border-left:1px solid black;padding:0px 5px;text-align:center;height:24px;line-height:24px">'+i.quantity+'</div><div style="float:left;border-left:1px solid black;padding:0px 5px;width:230px;text-align:center;height:24px;line-height:24px;">$'+p(r(n[t].original))+' > <span margin-price style="font-weight:600">'+i.price+"</span><span margin-percent> (+"+(100*i.margin-100).toFixed(1)+'%)</span></div><div margin-total style="float:left;border-left:1px solid black;width:75px;text-align:center;height:24px;line-height:24px">'+i.total+"</div></div>")}),$("[margin] [margin-content]").append('<div class="ac" style="padding:10px 10px 0px 10px;"><input cent style="width:60px;text-align:center" /> %</div><div style="width:100%;padding:10px;"><input range type="range" style="width:200px;margin:0 auto"></div><div class="wrapper" style="padding:10px"><button margin-apply class="wolfe-btn pull-right">APPLY</button><button margin-cancel class="wolfe-btn blue pull-right" style="margin-right:5px">CANCEL</button></div>'),$("[margin] [cent], [margin] [range]").val(0),$("[fade]").animate({opacity:.5},150,function(){$("[margin] [margin-content]").animate({opacity:1},100)}),$("[margin] [range], [margin] [cent]").on("input",function(){$("[margin] [cent]").val($(this).val()),$("[margin] [range]").val($(this).val());var t=(Number($("[cent]").val())+100)/100;$("[margin] [item-id]").each(function(){var a=$(this).attr("item-id");if($(this).find("input[type=checkbox]")[0].checked){var o=n[a].original,d=$(this).find("[margin-qty]").html().replace("$","").replace(",","");$(this).find("[margin-price]").html("$"+p(r(o*t))),$(this).find("[margin-percent]").html(" (+"+Number(100*t-100).toFixed(1)+"%)"),$(this).find("[margin-total]").html("$"+p(r(o*t*d))),i.map[e].items[a].margin=t}})}),$("input:checkbox").on("change",function(){var t=$(this).closest("[item-id]");t.hasClass("lowlight")?t.removeClass("lowlight"):t.addClass("lowlight")}),$("[margin] [margin-apply]").on("click",function(){t.find(a).each(function(){var t=i.p.get("this-item-id",$(this));$(this).html($('[margin] [item-id="'+t+'"] span').html())}),i.refresh(t),i.update(t),$("[margin] [margin-content]").fadeOut(100,function(){$("[fade]").fadeOut(150,function(){$("[margin]").off().unbind().remove()})})}),$("[margin] [margin-cancel]").on("click",function(){i.update(t),$("[margin] [margin-content]").fadeOut(100,function(){$("[fade]").fadeOut(150,function(){$("[margin]").off().unbind().remove(),i.refresh(t),i.update(t)})})}),$("[fade]").on("click",function(){i.update(t),$("[margin] [margin-content]").fadeOut(100,function(){$("[fade]").fadeOut(150,function(){$("[margin]").off().unbind().remove(),i.refresh(t),i.update(t)})})})},Form.prototype.marginOLD=function(t){var i=this,e=t.attr("data-formid"),n=[];i.dark(t);var a=t.find($(i.p.get("form-content",t))),o=$(this).closest($(".box")),r={html:{clone:a.clone(),position:a.offset(),width:a.outerWidth()},margin:{clone:o.clone(),position:o.offset(),width:o.outerWidth()}};$("#content").after("<div margin></div>"),$("[margin]").append('<div fade style="width:10000px;height:10000px;background-color:black;opacity:0.0;position:fixed;top:0;z-index:2;overflow:hidden;" disable></div>').append(r.html.clone.css({"z-index":999,position:"absolute",top:r.html.position.top,left:r.html.position.left,width:r.html.width,"margin-top":0,"background-color":"white","box-shadow":"0 0 20px rgba(0,0,0,.33)",opacity:0})),$("[fade]").animate({opacity:.5},150,function(){$("[margin] [form-content]").animate({opacity:1},100)}),$("[margin] [form-content]").append('<div class="ac" style="padding:10px 10px 0px 10px;"><input cent style="width:60px;text-align:center" /> %</div><div style="width:100%;padding:10px;"><input range type="range" style="width:200px;margin:0 auto"></div><div class="wrapper" style="padding:10px"><button margin-apply class="wolfe-btn pull-right">APPLY</button><button margin-cancel class="wolfe-btn blue pull-right" style="margin-right:5px">CANCEL</button></div>'),$("[margin] [cent], [margin] [range]").val(0);var p=i.p.get("remove"),d={},m=i.p.get("item-price"),c=function(t){return t.toFixed(2)},l=function(t){return t.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")};$("[margin] "+p).each(function(){var t=i.p.get("this-item-id",$(this));$(this).prev().removeAttr("contenteditable"),$(this).replaceWith('<input type="checkbox" class="twig-remove" style="width:15px;height:15px;margin-right:15px" data-item="'+t+'">')}),$("[margin] "+m).each(function(){var t=i.p.get("this-item-id",$(this)),n=i.map[e].items[t].margin;d[t]={current:$(this).html(),original:Number($(this).html().replace("$","").replace(",",""))/n}}),$("[margin] [range], [margin] [cent]").on("input",function(){$("[margin] [cent]").val($(this).val()),$("[margin] [range]").val($(this).val());var t=(Number($("[cent]").val())+100)/100;$("[margin] input[type=checkbox]").each(function(){$(this)[0].checked&&n.push($(this).attr("data-item"))}),$("[margin] "+m).each(function(){var a=i.p.get("this-item-id",$(this));if(n.includes(a)){var o=d[a].original;$(this).html("$"+l(c(o*t))),i.map[e].items[a].margin=t}})}),$("[margin] [margin-apply]").on("click",function(){t.find(m).each(function(){var t=i.p.get("this-item-id",$(this));$(this).html($('[margin] [data-item="'+t+'"] '+m).html())}),i.update(t),$("[margin] [form-content]").fadeOut(100,function(){$("[fade]").fadeOut(150,function(){$("[margin]").off().unbind().remove()})})}),$("[margin] [margin-cancel]").on("click",function(){i.update(t),$("[margin] [form-content]").fadeOut(100,function(){$("[fade]").fadeOut(150,function(){$("[margin]").off().unbind().remove(),i.update(t)})})}),$("[fade]").on("click",function(){i.update(t),$("[margin] [form-content]").fadeOut(100,function(){$("[fade]").fadeOut(150,function(){$("[margin]").off().unbind().remove(),i.update(t)})})})},Form.prototype["delete"]=function(t,i){void 0!=t.url&&void 0!=t.form_id&&$.post(t.url,{id:t.form_id}).done(function(t){"0"!=t?void 0!=i&&i(!0):(void 0!=i&&i(!1),console.log("Form delete failed with Slim 0"))}).fail(function(){void 0!=i&&i(!1),console.log("Internal Server Error")})},Form.prototype.post=function(t,i){var e=this;void 0!=t.url&&void 0!=t.template_id&&void 0!=t.client_id&&void 0!=t.job_id&&void 0!=t.job_number&&$.post(t.url,{template_id:t.template_id,client_id:t.client_id,job_id:t.job_id}).done(function(n){var n=JSON.parse(n),a=e.tab.objParent,o=Number($(a).find("["+e.tab.heir+"]").attr(e.tab.objhook)),r=n.id;$(a).find("["+e.tab.heir+"]").before("<div "+e.tab.objhook+'="'+o+'" class="'+e.tab.obj+' h">'+n.html+"</div>"),$(a).find("["+e.tab.heir+"]").replaceWith("<div "+e.tab.objhook+'="'+(o+1)+'" '+e.tab.heir+" hidden></div>"),$("["+e.tab.objhook+'="'+o+'"]').find("[form-blob]").attr("data-formid",r);var p=$('[data-formid="'+r+'"]');e.crawl(p),e.tab.append(t.template_name,function(){e.populate(p,{job_number:t.job_number,date:n.date,client:n.client}),e.put({url:environment.root+"/put/form",id:r},function(){e.construct(p),i(p)})})}).fail(function(){void 0!=i&&i(!1),console.log("Internal Server Error")})},Form.prototype.put=function(t,i){var e=this,n=$('[data-formid="'+t.id+'"]'),a=n.clone();e.p["do"]("flush-items",a);var o=e.strip(a);void 0!=t.url&&void 0!=t.id?$.post(t.url,{id:t.id,html:o,json:JSON.stringify(e.map[t.id])}).done(function(){"0"!=t?void 0!=i&&i(!0):(void 0!=i&&i(!1),console.log("Form put failed with Slim 0"))}).fail(function(){void 0!=i&&i(!1),console.log("Internal Server Error")}):console.log("URL or data.id not supplied, form not saved.")};