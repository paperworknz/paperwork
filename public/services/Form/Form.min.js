var Form=function(){var t=this;t.pw=pw,t.tab=tab,t.p=new Painter,t.s="."+t.tab.activeObj,t.form="[form-blob]",t.map={},$.get(environment.root+"/get/inv",function(o){$.get(environment.root+"/get/form/"+environment.jobID,function(e){var n=[],i=JSON.parse(e),a=!0;t.inv=JSON.parse(o),$.each(t.inv,function(t,o){n.push(t)}),t.typeahead=new Typeahead(n),$(t.form).each(function(){var o=$(this),e=o.attr("data-formid");void 0!=i[e]||null!=i[e]?(t.map[e]=i[e],a=!1):t.crawl(o),a||t.construct(o)}),"Zamorak"==t.p.is&&(a&&$.each(t.map,function(o,e){t.put({url:environment.root+"/put/form-json",formID:o,json:JSON.stringify(e)})}),a&&!$.isEmptyObject(t.map)&&location.reload(),$.isEmptyObject(t.map)&&$.post(environment.root+"/post/army",{jobID:environment.jobID},function(){location.reload()}),a||($(t.form).each(function(){var o=$(this),e=o.attr("data-formid");t.put({url:environment.root+"/put/form",formID:e})}),$.post(environment.root+"/post/army",{jobID:environment.jobID},function(){location.reload()})))})})};Form.prototype.dark=function(t){t.off().unbind()},Form.prototype.populate=function(t,o){var e=this;e.p.set("date",t,o.date),e.p.set("jobID",t,o.jobID),e.p.set("client",t,o.client)},Form.prototype.strip=function(t){var o=this,e=t.clone();return e=o.p.strip(e),e.html()},Form.prototype.update=function(t){var o=this,e=($(t).attr("data-formID"),0),n=function(t){return t.toFixed(2)},i=function(t){return t.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")};o.p.each("item",t,function(a){var r=a.itemID,p=(a.name,a.quantity.replace(",","")),m=a.price.replace("$","").replace(",",""),c=n(Number(m)),u=n(Number(p)*c);e+=Number(u),m=c>0?c:m,o.p["do"]("price-by-ID",t,{itemID:r,val:"$"+i(m)}),o.p["do"]("total-by-ID",t,{itemID:r,val:"$"+i(u)})});var a=n(e),r=n(3*e/2/10),p=n(Number(a)+Number(r));o.p.set("subtotal",t,"$"+i(a)),o.p.set("tax",t,"$"+i(r)),o.p.set("total",t,"$"+i(p)),o.crawl(t),void 0!=o.p.update&&o.p.update(t)},Form.prototype.construct=function(t){var o=this,e=t.attr("data-formid");void 0!=o.p.flush&&o.p.flush(t),o.dark(t),$(o.tab.objParent).on("change",function(){o.update(t)}),o.p.on("qty",$(o.tab.objParent),"input",function(){o.update(t)}),o.p.on("price",$(o.tab.objParent),"blur",function(){o.update(t)}),o.p.on("price",$(o.tab.objParent),"input",function(t){13==t.event.keyCode&&(t.event.preventDefault(),t.element.blur())}),t.on("click",".twig-remove",function(){o.p["do"]("this-remove-item",$(this)),o.update(t)}),o.p.initialiseTypeahead(t,function(){o.typeahead.run(t)}),t.bind("typeahead:select",".typeahead",function(){return 13==event.which?void 0:void o.append(t,$(o.s).find(".tt-input").val())}),t.on("keydown",".typeahead",function(){13==event.which&&o.append(t,$(o.s).find(".tt-input").val())});var n=$("."+o.tab.activeTab).attr(o.tab.tabhook),i=$("."+o.tab.activeTab).html();t.closest("."+o.tab.obj).find("[form-pdf-name]").val(n+"-"+i.toLowerCase()),$.each(o.map[e].items,function(e,n){o.p.append(t,{itemID:n.itemID,item:n.item,quantity:n.quantity,price:n.price})}),o.update(t),t.css("pointer-events","auto"),t.animate({opacity:1},500)},Form.prototype.append=function(t,o,e,n){var i=this,o=void 0!==o?o:"",e=void 0!==e?e:"",n=void 0!==n?n:"",a=($(t).attr("data-formid"),i.p.get("latest-item-id",t)),r=void 0===e?!1:!0;void 0===a&&(a=0),a=Number(a)+1,i.inv[o]&&""===n&&(n=r=i.inv[o]),o||(o=n=""),"0.00"==n&&(n=""),i.p.append(t,{itemID:a,item:o,quantity:e,price:n}),13==event.which&&event.preventDefault(),r===!1&&void 0!=o&&swal({html:!0,title:"Add "+o+" to your inventory?",text:"If you save this item you can use it again in future.",showCancelButton:!0,closeOnConfirm:!0,cancelButtonText:"No",confirmButtonText:"Yes"},function(){$.post(environment.root+"/post/inv",{name:o,price:"0.00"})}),$(".typeahead").typeahead("val",""),i.p["do"]("focus-last-item-quantity",t),i.update(t)},Form.prototype.crawl=function(t){var o=this,e=t.attr("data-formid");o.map[e]={items:{},subtotal:0,tax:0,total:0},o.p.each("item",t,function(t){void 0===o.map[e].items[t.itemID]&&(o.map[e].items[t.itemID]={}),o.map[e].items[t.itemID].itemID=t.itemID,o.map[e].items[t.itemID].item=t.item,o.map[e].items[t.itemID].quantity=t.quantity,o.map[e].items[t.itemID].price=t.price,o.map[e].items[t.itemID].total=t.total}),o.map[e].subtotal=o.p.get("subtotal",t),o.map[e].tax=o.p.get("tax",t),o.map[e].total=o.p.get("total",t)},Form.prototype.copy=function(t){var o=this,e=t.attr("data-formid");swal({title:"Choose your template",text:"1 for Quote, 2 for Invoice",type:"input",inputPlaceholder:"Write something",showCancelButton:!0,html:!0},function(n){if(0!=n){var i=$(this),a=n,r="Invoice";r=1==a?"Quote":"Invoice";var p={client:o.p.get("client",t),jobd:o.p.get("jobd",t),content:o.map[e]};pw.wait(i),o.post({url:environment.root+"/post/form",templateID:a,templateName:r,clientID:environment.clientID,jobID:environment.jobID},function(t){$.each(o.map[e].items,function(e,n){o.p.append(t,{itemID:n.itemID,item:n.item,quantity:n.quantity,price:n.price})});var n=t.attr("data-formid");o.p.set("client",t,p.client),o.p.set("jobd",t,p.jobd),o.construct(t),o.put({url:environment.root+"/put/form",formID:n},function(){pw.ready(i,"COPY")})})}})},Form.prototype.copy=function(t){var o=this,e=t.attr("data-formid");swal({title:"Choose your template",text:"1 for Quote, 2 for Invoice",type:"input",inputPlaceholder:"Write something",showCancelButton:!0,html:!0},function(n){if(0!=n){var i=$(this),a=n,r="Invoice";r=1==a?"Quote":"Invoice";var p={client:o.p.get("client",t),jobd:o.p.get("jobd",t),content:o.map[e]};pw.wait(i),o.post({url:environment.root+"/post/form",templateID:a,templateName:r,clientID:environment.clientID,jobID:environment.jobID},function(t){$.each(o.map[e].items,function(e,n){o.p.append(t,{itemID:n.itemID,item:n.item,quantity:n.quantity,price:n.price})});var n=t.attr("data-formid");o.p.set("client",t,p.client),o.p.set("jobd",t,p.jobd),o.construct(t),o.put({url:environment.root+"/put/form",formID:n},function(){pw.ready(i,"COPY")})})}})},Form.prototype.pdf=function(t,o){var e=this,n=t.clone();n=e.strip(n);var i="<!DOCTYPE html><html lang='en'><head><meta name='viewport' content='width=device-width,initial-scale=1.0'><link rel='stylesheet' href='https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css' type='text/css'></head><body>"+n+"</body>";o(i)},Form.prototype["delete"]=function(t,o){void 0!=t.url&&void 0!=t.formID&&$.post(t.url,{formID:t.formID}).done(function(t){"0"!=t?void 0!=o&&o(!0):(void 0!=o&&o(!1),console.log("Form delete failed with Slim 0"))}).fail(function(){void 0!=o&&o(!1),console.log("Internal Server Error")})},Form.prototype.post=function(t,o){var e=this;void 0!=t.url&&void 0!=t.templateID&&void 0!=t.clientID&&void 0!=t.jobID&&$.post(t.url,{templateID:t.templateID,clientID:t.clientID,jobID:t.jobID}).done(function(n){var n=JSON.parse(n),i=e.tab.objParent,a=Number($(i).find("["+e.tab.heir+"]").attr(e.tab.objhook));$(i).find("["+e.tab.heir+"]").before("<div "+e.tab.objhook+'="'+a+'" class="'+e.tab.obj+' h">'+n.html+"</div>"),$(i).find("["+e.tab.heir+"]").replaceWith("<div "+e.tab.objhook+'="'+(a+1)+'" '+e.tab.heir+" hidden></div>"),$("["+e.tab.objhook+'="'+a+'"]').find("[form-blob]").attr("data-formid",n.formID);var r=$('[data-formid="'+n.formID+'"]');e.crawl(r),e.tab.append(t.templateName,function(){e.populate(r,{jobID:t.jobID,date:n.date,client:n.client}),e.put({url:environment.root+"/put/form",formID:n.formID},function(){e.construct(r),o(r)})})}).fail(function(){void 0!=o&&o(!1),console.log("Internal Server Error")})},Form.prototype.put=function(t,o){var e=this,n=t.formID,i=$('[data-formid="'+n+'"]'),a=i.clone();e.p["do"]("flush-items",a);var r=e.strip(a);void 0!=t.url&&void 0!=n?$.post(t.url,{formID:n,html:r,json:JSON.stringify(e.map[n])}).done(function(t){"0"!=t?void 0!=o&&o(!0):(void 0!=o&&o(!1),console.log("Form put failed with Slim 0"))}).fail(function(){void 0!=o&&o(!1),console.log("Internal Server Error")}):console.log("URL or formID not supplied, form not saved.")};