var Form=function(){var t=this;t.pw=pw,t.tab=tab,t.p=new Painter,t.s="."+t.tab.activeObj,t.form="[form-blob]",t.map={},$.get(environment.root+"/get/inv",function(e){$.get(environment.root+"/get/form/"+environment.jobID,function(o){var i=[],n=JSON.parse(o);t.inv=JSON.parse(e),$.each(t.inv,function(t,e){i.push(t)}),t.typeahead=new Typeahead(i),$(t.form).each(function(){var e=$(this),o=e.attr("data-formid");void 0!=n[o]||null!=n[o]?t.map[o]=n[o]:t.crawl(e),t.construct(e)})})})};Form.prototype.append=function(t,e,o,i){var n=this,e=void 0!==e?e:"",o=void 0!==o?o:"",i=void 0!==i?i:"",a=($(t).attr("data-formid"),n.p.get("latest-item-id",t)),r=void 0!==o;void 0===a&&(a=0),a=Number(a)+1,n.inv[e]&&""===i&&(i=r=n.inv[e]),e||(e=i=""),"0.00"==i&&(i=""),n.p.append(t,{itemID:a,item:e,quantity:o,price:i}),13==event.which&&event.preventDefault(),r===!1&&void 0!=e&&swal({html:!0,title:"Add "+e+" to your inventory?",text:"If you save this item you can use it again in future.",showCancelButton:!0,closeOnConfirm:!0,cancelButtonText:"No",confirmButtonText:"Yes"},function(){$.post(environment.root+"/post/inv",{name:e,price:"0.00"})}),$(".typeahead").typeahead("val",""),n.p["do"]("focus-last-item-quantity",t),n.update(t)},Form.prototype.construct=function(t){var e=this,o=t.attr("data-formid");e.dark(t),$(e.tab.objParent).on("change",function(){e.update(t)}),e.p.on("qty",$(e.tab.objParent),"input",function(){e.update(t)}),e.p.on("price",$(e.tab.objParent),"blur",function(){e.update(t)}),e.p.on("price",$(e.tab.objParent),"input",function(t){13==t.event.keyCode&&(t.event.preventDefault(),t.element.blur())}),t.on("click",".twig-remove",function(){e.p["do"]("this-remove-item",$(this)),e.update(t)}),e.p.initialiseTypeahead(t,function(){e.typeahead.run(t)}),t.bind("typeahead:select",".typeahead",function(){return 13==event.which?void 0:void e.append(t,$(e.s).find(".tt-input").val())}),t.on("keydown",".typeahead",function(){13==event.which&&e.append(t,$(e.s).find(".tt-input").val())});var i=$("."+e.tab.activeTab).attr(e.tab.tabhook),n=$("."+e.tab.activeTab).html();t.closest("."+e.tab.obj).find("[form-pdf-name]").val(i+"-"+n.toLowerCase()),$.each(e.map[o].items,function(o,i){e.p.append(t,{itemID:i.itemID,item:i.item,quantity:i.quantity,price:i.price})}),e.update(t),t.css("pointer-events","auto"),t.animate({opacity:1},500)},Form.prototype.crawl=function(t){var e=this,o=t.attr("data-formid");e.map[o]={items:{},subtotal:0,tax:0,total:0},e.p.each("item",t,function(t){void 0===e.map[o].items[t.itemID]&&(e.map[o].items[t.itemID]={}),e.map[o].items[t.itemID].itemID=t.itemID,e.map[o].items[t.itemID].item=t.item,e.map[o].items[t.itemID].quantity=t.quantity,e.map[o].items[t.itemID].price=t.price,e.map[o].items[t.itemID].total=t.total}),e.map[o].subtotal=e.p.get("subtotal",t),e.map[o].tax=e.p.get("tax",t),e.map[o].total=e.p.get("total",t)},Form.prototype.dark=function(t){t.off().unbind()},Form.prototype.populate=function(t,e){var o=this;o.p.set("date",t,e.date),o.p.set("jobID",t,e.jobID),o.p.set("client",t,e.client)},Form.prototype.strip=function(t){var e=this,o=t.clone();return o=e.p.strip(o),o.html()},Form.prototype.update=function(t){var e=this,o=($(t).attr("data-formID"),0),i=function(t){return t.toFixed(2)},n=function(t){return t.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")};e.p.each("item",t,function(a){var r=a.itemID,p=(a.name,a.quantity.replace(",","")),m=a.price.replace("$","").replace(",",""),c=i(Number(m)),d=i(Number(p)*c);o+=Number(d),m=c>0?c:m,e.p["do"]("price-by-ID",t,{itemID:r,val:"$"+n(m)}),e.p["do"]("total-by-ID",t,{itemID:r,val:"$"+n(d)})});var a=i(o),r=i(3*o/2/10),p=i(Number(a)+Number(r));e.p.set("subtotal",t,"$"+n(a)),e.p.set("tax",t,"$"+n(r)),e.p.set("total",t,"$"+n(p)),e.crawl(t),void 0!=e.p.update&&e.p.update(t)},Form.prototype.copy=function(t){var e=this,o=t.attr("data-formid");swal({title:"Choose your template",text:"1 for Quote, 2 for Invoice",type:"input",inputPlaceholder:"Write something",showCancelButton:!0,html:!0},function(i){if(0!=i){var n=$(this),a=i,r="Invoice";r=1==a?"Quote":"Invoice";var p={client:e.p.get("client",t),jobd:e.p.get("jobd",t),content:e.map[o]};pw.wait(n),e.post({url:environment.root+"/post/form",templateID:a,templateName:r,clientID:environment.clientID,jobID:environment.jobID},function(t){$.each(e.map[o].items,function(o,i){e.p.append(t,{itemID:i.itemID,item:i.item,quantity:i.quantity,price:i.price})});var i=t.attr("data-formid");e.p.set("client",t,p.client),e.p.set("jobd",t,p.jobd),e.construct(t),e.put({url:environment.root+"/put/form",formID:i},function(){pw.ready(n,"COPY")})})}})},Form.prototype.margin=function(t){var e=this,o=(t.attr("data-formid"),[]);e.dark(t);var i=t.find($(e.p.get("form-content",t))),n=$(this).closest($(".box")),a={html:{clone:i.clone(),position:i.offset(),width:i.outerWidth()},margin:{clone:n.clone(),position:n.offset(),width:n.outerWidth()}};$("#content").after("<div margin></div>"),$("[margin]").append('<div fade style="width:10000px;height:10000px;background-color:black;opacity:0.0;position:fixed;top:0;z-index:2;overflow:hidden;" disable></div>').append(a.html.clone.css({"z-index":999,position:"absolute",top:a.html.position.top,left:a.html.position.left,width:a.html.width,"margin-top":0,"background-color":"white","box-shadow":"0 0 20px rgba(0,0,0,.33)",opacity:0})),$("[fade]").animate({opacity:.5},150,function(){$("[margin] [form-content]").animate({opacity:1},100)}),$("[margin] [form-content]").append('<div class="ac" style="padding:10px 10px 0px 10px;"><input cent style="width:60px;text-align:center" /> %</div><div style="width:100%;padding:10px;"><input range type="range" style="width:200px;margin:0 auto"></div><div class="wrapper" style="padding:10px"><button margin-apply class="wolfe-btn pull-right">APPLY</button><button margin-cancel class="wolfe-btn blue pull-right" style="margin-right:5px">CANCEL</button></div>'),$("[margin] [form-content] input").val(0);var r=e.p.get("remove"),p=[],m=e.p.get("item-price"),c=function(t){return t.toFixed(2)},d=function(t){return t.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")};$("[margin] "+r).each(function(){var t=e.p.get("this-item-id",$(this));$(this).prev().removeAttr("contenteditable"),$(this).replaceWith('<input type="checkbox" class="twig-remove" style="width:15px;height:15px;margin-right:15px" data-item="'+t+'">')}),$("[margin] "+m).each(function(){var t=e.p.get("this-item-id",$(this));p[t]=$(this).html()}),$("[margin] [range]").on("input",function(){$("[cent]").val($(this).val());var t=(Number($("[cent]").val())+100)/100;$("[margin] input[type=checkbox]").each(function(){$(this)[0].checked&&o.push($(this).attr("data-item"))}),$("[margin] "+m).each(function(){var i=e.p.get("this-item-id",$(this));if(o.includes(i)){var n=Number(p[i].replace("$","").replace(",",""));$(this).html("$"+d(c(n*t)))}})}),$("[margin] [margin-apply]").on("click",function(){t.find(m).each(function(){var t=e.p.get("this-item-id",$(this));$(this).html($('[margin] [data-item="'+t+'"] '+m).html())}),e.update(t),$("[margin] [form-content]").fadeOut(100,function(){$("[fade]").fadeOut(150,function(){$("[margin]").off().unbind().remove()})})}),$("[margin] [margin-cancel]").on("click",function(){e.update(t),$("[margin] [form-content]").fadeOut(100,function(){$("[fade]").fadeOut(150,function(){$("[margin]").off().unbind().remove(),e.update(t)})})})},Form.prototype.pdf=function(t,e){var o=this,i=t.clone();i=o.strip(i);var n="<!DOCTYPE html><html lang='en'><head><meta name='viewport' content='width=device-width,initial-scale=1.0'><link rel='stylesheet' href='https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css' type='text/css'></head><body>"+i+"</body>";e(n)},Form.prototype["delete"]=function(t,e){void 0!=t.url&&void 0!=t.formID&&$.post(t.url,{formID:t.formID}).done(function(t){"0"!=t?void 0!=e&&e(!0):(void 0!=e&&e(!1),console.log("Form delete failed with Slim 0"))}).fail(function(){void 0!=e&&e(!1),console.log("Internal Server Error")})},Form.prototype.post=function(t,e){var o=this;void 0!=t.url&&void 0!=t.templateID&&void 0!=t.clientID&&void 0!=t.jobID&&$.post(t.url,{templateID:t.templateID,clientID:t.clientID,jobID:t.jobID}).done(function(i){var i=JSON.parse(i),n=o.tab.objParent,a=Number($(n).find("["+o.tab.heir+"]").attr(o.tab.objhook));$(n).find("["+o.tab.heir+"]").before("<div "+o.tab.objhook+'="'+a+'" class="'+o.tab.obj+' h">'+i.html+"</div>"),$(n).find("["+o.tab.heir+"]").replaceWith("<div "+o.tab.objhook+'="'+(a+1)+'" '+o.tab.heir+" hidden></div>"),$("["+o.tab.objhook+'="'+a+'"]').find("[form-blob]").attr("data-formid",i.formID);var r=$('[data-formid="'+i.formID+'"]');o.crawl(r),o.tab.append(t.templateName,function(){o.populate(r,{jobID:t.jobID,date:i.date,client:i.client}),o.put({url:environment.root+"/put/form",formID:i.formID},function(t){console.log(t),o.construct(r),e(r)})})}).fail(function(){void 0!=e&&e(!1),console.log("Internal Server Error")})},Form.prototype.put=function(t,e){var o=this,i=t.formID,n=$('[data-formid="'+i+'"]'),a=n.clone();o.p["do"]("flush-items",a);var r=o.strip(a);void 0!=t.url&&void 0!=i?$.post(t.url,{formID:i,html:r,json:JSON.stringify(o.map[i])}).done(function(t){"0"!=t?void 0!=e&&e(!0):(void 0!=e&&e(!1),console.log("Form put failed with Slim 0"))}).fail(function(){void 0!=e&&e(!1),console.log("Internal Server Error")}):console.log("URL or formID not supplied, form not saved.")};