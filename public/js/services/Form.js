"use strict";var Form=function(){var t=this;t.pw=Paperwork,t.tab=tab,t.p=new Painter,t.s="."+t.tab.activeObj,t.form="[form-blob]",t.map={},$.get(environment.root+"/get/inventory",function(e){$.get(environment.root+"/get/form/"+environment.job_id,function(n){var i=[],a=JSON.parse(n);$.each(a,function(t,e){$.each(e.items,function(e,n){void 0!=n.margin&&0!=n.margin||(a[t].items[e].margin="1")})}),t.inv=JSON.parse(e),$.each(t.inv,function(t,e){i.push(t)}),t.typeahead=new Typeahead(i),$(t.form).each(function(){var e=$(this),n=e.attr("data-formid");void 0!=a[n]||null!=a[n]?t.map[n]=a[n]:t.crawl(e),t.construct(e)})})})};Form.prototype.append=function(t,e,n,i){var a=this,e=void 0!==e?e:"",n=void 0!==n?n:"",i=void 0!==i?i:"",o=($(t).attr("data-formid"),a.p.get("latest-item-id",t)),r=!1;void 0===o&&(o=0),o=Number(o)+1,a.inv[e]&&""===i&&(i=r=a.inv[e]),e||(e=i=""),"0.00"==i&&(i=""),a.p.append(t,{itemID:o,item:e,quantity:n,price:i}),13==event.which&&event.preventDefault(),r===!1&&void 0!=e&&swal({html:!0,title:"Add "+e+" to your inventory?",text:"If you save this item you can use it again in future.",showCancelButton:!0,closeOnConfirm:!0,cancelButtonText:"No",confirmButtonText:"Yes"},function(){$.post(environment.root+"/post/inv",{name:e,price:"0.00"})}),$(".typeahead").typeahead("val",""),a.p["do"]("focus-last-item-quantity",t),a.update(t)},Form.prototype.construct=function(t){var e=this,n=t.attr("data-formid");e.refresh(t),$.each(e.map[n].items,function(n,i){e.p.append(t,{itemID:i.itemID,item:i.item,quantity:i.quantity,price:i.price})}),e.update(t),t.css("pointer-events","auto"),t.animate({opacity:1},500)},Form.prototype.crawl=function(t){var e=this,n=t.attr("data-formid"),i={};void 0!=e.map[n]&&$.each(e.map[n].items,function(t,e){void 0!==e.margin||0==e.margin?i[t]=e.margin:i[t]="1"}),e.map[n]={items:{},subtotal:0,tax:0,total:0},e.p.each("item",t,function(t){void 0===e.map[n].items[t.itemID]&&(e.map[n].items[t.itemID]={}),e.map[n].items[t.itemID].itemID=t.itemID,e.map[n].items[t.itemID].item=t.item,e.map[n].items[t.itemID].quantity=t.quantity,e.map[n].items[t.itemID].price=t.price,e.map[n].items[t.itemID].total=t.total,void 0!=i[t.itemID]&&(e.map[n].items[t.itemID].margin=i[t.itemID])}),e.map[n].subtotal=e.p.get("subtotal",t),e.map[n].tax=e.p.get("tax",t),e.map[n].total=e.p.get("total",t)},Form.prototype.dark=function(t){t.off().unbind()},Form.prototype.populate=function(t,e){var n=this;n.p.set("date",t,e.date),n.p.set("jobID",t,e.job_number),n.p.set("client",t,e.client)},Form.prototype.refresh=function(t){var e=this;e.dark(t),$(e.tab.objParent).on("change",function(){e.update(t)}),e.p.on("qty",$(e.tab.objParent),"input",function(){e.update(t)}),e.p.on("price",$(e.tab.objParent),"blur",function(){e.update(t)}),e.p.on("price",$(e.tab.objParent),"input",function(t){13==t.event.keyCode&&(t.event.preventDefault(),t.element.blur())}),t.on("click",".twig-remove",function(){e.p["do"]("this-remove-item",$(this)),e.update(t)}),e.p.initialiseTypeahead(t,function(){e.typeahead.run(t)}),t.bind("typeahead:select",".typeahead",function(){return 13==event.which?void 0:void e.append(t,$(e.s).find(".tt-input").val())}),t.on("keydown",".typeahead",function(){13==event.which&&e.append(t,$(e.s).find(".tt-input").val())})},Form.prototype.strip=function(t){var e=this,n=t.clone();return n=e.p.strip(n),n.html()},Form.prototype.update=function(t){var e=this,n=$(t).attr("data-formid"),i=0,a=function(t){return t.toFixed(2)},o=function(t){return t.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")};e.p.each("item",t,function(r){var c=r.itemID,l=(r.name,r.quantity.replace(",","")),p=r.price.replace("$","").replace(",",""),m=a(Number(p)),d=a(Number(l)*m);i+=Number(d),p=m>0?m:p,e.p["do"]("price-by-ID",t,{itemID:c,val:"$"+o(p)}),e.p["do"]("total-by-ID",t,{itemID:c,val:"$"+o(d)}),void 0!=e.map[n].items[c]&&p!=e.map[n].items[c].price.replace("$","").replace(",","")&&0==$(".margin-content").length&&(e.map[n].items[c].margin=1)});var r=a(i),c=a(3*i/2/10),l=a(Number(r)+Number(c));e.p.set("subtotal",t,"$"+o(r)),e.p.set("tax",t,"$"+o(c)),e.p.set("total",t,"$"+o(l)),e.crawl(t),void 0!=e.p.update&&e.p.update(t)},Form.prototype.margin=function(t){var e,n=this,i=t.attr("data-formid"),a=(n.p.get("remove"),{}),o={},r=n.p.get("item-price"),c=(t.find($(n.p.get("form-content",t))),function(t){return t.toFixed(2)}),l=function(t){return t.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")};$.each(n.map[i].items,function(t,e){var n=t;a[n]={margin:e.margin,current:e.price,original:Number(e.price.replace("$","").replace(",",""))/e.margin}}),o={subtotal:Number(n.map[i].subtotal.replace("$","").replace(",","")),tax:Number(n.map[i].tax.replace("$","").replace(",","")),total:Number(n.map[i].total.replace("$","").replace(",",""))},n.dark(t);var p=Paperwork.dark(),m=p.object,d=p.object.find(".dark_object");d.after('\n		<div class="margin-content">\n			<div class="container">\n				<div class="margin-parent">\n				</div>\n			</div>\n		</div>\n	');var s=$(".margin-content"),e=s.find(".margin-parent");$.each(n.map[i].items,function(t,n){var i=(l(c(a[t].original)),"0.0"!==(100*n.margin-100).toFixed(1)?" ("+(100*n.margin-100).toFixed(1)+"%)":"");e.append('\n			<div class="margin-item wrap lowlight" item-id="'+t+'">\n				<div class="left">\n					<input type="checkbox" style="margin-left: 5px;">\n				</div>\n				<div class="left margin-name">\n					'+n.item+'\n				</div>\n				<div class="margin-qty left centered">\n					'+n.quantity+'\n				</div>\n				<div class="margin-price-container left centered">\n					<span class="margin-price">\n						'+n.price+'\n					</span>\n					<span class="margin-percent">\n						'+i+'\n					</span>\n				</div>\n				<div class="margin-total left">\n					'+n.total+"\n				</div>\n			</div>\n		")}),s.append('\n		<div class="wrap container-mid" style="position: relative;">\n			<div class="wrap">\n				<div class="container-top centered">\n					<input class="percent centered" /> %\n				</div>\n				<div class="container-top centered">\n					<input class="range" type="range" />\n				</div>\n			</div>\n			<div style="position:absolute;right:15px;top:0;border:1px solid black;">\n				<ul class="left" style="text-align:right;padding:0;border-right:1px solid black;">\n					<li style="padding:2px 10px;">Sub Total</li>\n					<li style="padding:2px 10px;">GST</li>\n					<li style="padding:2px 10px;font-weight:600;">Total</li>\n				</ul>\n				<ul class="left" style="text-align:left;padding:0;min-width:93px;">\n					<li margin-subtotal style="padding:2px 10px;">$'+l(c(o.subtotal))+'</li>\n					<li margin-tax style="padding:2px 10px;">$'+l(c(o.tax))+'</li>\n					<li margin-totalend style="padding:2px 10px;font-weight:600;">$'+l(c(o.total))+'</li>\n				</ul>\n			</div>\n		</div>\n		<div class="wrap container">\n			<button margin-apply class="button right">APPLY</button>\n			<button margin-cancel class="button blue right" style="margin-right:5px">CANCEL</button>\n		</div>\n	'),s.find(".percent, .range").val(0),s.css({top:$(window).height()/2-$(".margin-content").height()/2}),p.run(function(){s.animate({opacity:1},100)});var u=s.find(".percent"),f=s.find(".range");s.find(".percent, .range").on("input",function(){u.val($(this).val()),f.val($(this).val());var t=(Number(u.val())+100)/100;m.find(".margin-item").each(function(){var e=$(this).attr("item-id");if($(this).find("input[type=checkbox]")[0].checked){var n=a[e].original,i=$(this).find(".margin-qty").html().replace("$","").replace(",",""),o=l(c(n*t));$(this).find(".margin-price").html("$"+o),$(this).find(".margin-percent").html(" (+"+Number(100*t-100).toFixed(1)+"%)"),$(this).find(".margin-total").html("$"+l(c(n*t*i))),a[e].current=o,a[e].margin=t}-1!==$(this).find(".margin-percent").html().indexOf("(+0.0%)")&&$(this).find(".margin-percent").html("")});var e=0;s.find(".margin-total").each(function(){e+=Number($(this).html().replace("$","").replace(",",""))}),e=c(e);var n=c(3*e/2/10),i=c(Number(e)+Number(n));$("[margin-subtotal]").html("$"+l(e)),$("[margin-tax]").html("$"+l(n)),$("[margin-totalend]").html("$"+l(i))}),$(".margin-content input:checkbox").on("change",function(){var t=$(this).closest("[item-id]");t.hasClass("lowlight")?t.removeClass("lowlight"):t.addClass("lowlight")}),$(".margin-content [margin-apply]").on("click",function(){t.find(r).each(function(){var t=n.p.get("this-item-id",$(this));n.map[i].items[t].margin=a[t].margin,$(this).html(a[t].current)}),n.refresh(t),n.update(t),n.put({url:environment.root+"/put/form",id:i}),s.fadeOut(100,function(){p.remove()})}),$(".margin-content [margin-cancel]").on("click",function(){n.update(t),s.fadeOut(100,function(){p.remove(function(){n.refresh(t),n.update(t)})})}),d.on("click",function(){n.update(t),s.fadeOut(100,function(){p.remove(function(){n.refresh(t),n.update(t)})})})},Form.prototype.mobile=function(t){var e=this,n=t.attr("data-formid"),i=e.map[n];t.find("[form-date]")&&(i.date=t.find("[form-date]").html()),t.find("[form-jobid]")&&(i.job_number=t.find("[form-jobid]").html()),t.find("[form-clientblob]")&&(i.client=t.find("[form-clientblob]").html()),t.find("[form-jobd]")&&(i.description=t.find("[form-jobb]").html()),console.log(e.map)},Form.prototype.copy=function(t,e){var n=this,i=t.attr("data-formid");t.find($(n.p.get("form-content",t)));n.dark(t);var a=Paperwork.dark(),o=(a.object,a.object.find(".dark_object"));o.after('\n		<div class="copy-content">\n			<div class="copy-parent wrap">\n				<div class="container-top">\n					<div class="h4 title centered ">\n						Use template:\n					</div>\n				</div>\n				<div class="container-mid">\n				</div>\n			</div>\n		</div>\n	'),$.each(e,function(t,e){$(".copy-content .copy-parent .container-mid").append('\n			<div class="new-template" data-templateid="'+t+'">\n				'+e+"\n			</div>\n		")}),$(".copy-content .copy-parent").append('\n		<div class="container wrap">\n			<button copy-cancel class="button blue right">\n				CANCEL\n			</button>\n		</div>\n	'),$(".copy-content").css({top:$(window).height()/2-$(".copy-content").height()/2}),a.run(function(){$(".copy-content").animate({opacity:1},100)}),$(".copy-content .new-template").on("click",function(){var e={client:n.p.get("client",t),jobd:n.p.get("jobd",t),content:n.map[i]},o=$(this).html(),r=$(this).attr("data-templateid");a.remove(function(){$(".copy-content").off().unbind().remove(),n.refresh(t),n.update(t)}),n.post({url:environment.root+"/post/form",template_name:o,template_id:r,client_id:environment.client_id,job_id:environment.job_id,job_number:environment.job_number},function(t){var a=t.attr("data-formid");$.each(n.map[i].items,function(e,i){n.p.append(t,{itemID:i.itemID,item:i.item,quantity:i.quantity,price:i.price})}),n.construct(t),$.each(n.map[a].items,function(t,e){n.map[a].items[t].margin=n.map[i].items[t].margin}),n.p.set("client",t,e.client),n.p.set("jobd",t,e.jobd),n.put({url:environment.root+"/put/form",id:a})})}),$(".copy-content [copy-cancel]").on("click",function(){n.update(t),$(".copy-content").fadeOut(100,function(){a.remove(function(){$(".copy-content").off().unbind().remove(),n.refresh(t),n.update(t)})})}),o.on("click",function(){n.update(t),$(".copy-content").fadeOut(100,function(){a.remove(function(){$(".copy-content").off().unbind().remove(),n.refresh(t),n.update(t)})})})},Form.prototype.email=function(t){var e,n,i=this,a=(t.attr("data-formid"),t.find($(i.p.get("form-content",t))),0);n=localStorage&&void 0!=localStorage.ep?localStorage.ep:null,e=$(".email-signature-raw").html(),i.dark(t);var o=Paperwork.dark(),r=(o.object,o.object.find(".dark_object"));r.after('\n		<div class="email-content">\n			<div class="email-parent wrap container">\n				<input class="email-email" type="text" style="width:50%" value="'+environment.client_email+'" placeholder="Email Address" required />\n				<input class="email-subject" type="text" placeholder="Subject Line" required />\n				<div class="email-body" style="padding:4px;width:100%;height:300px;border:1px solid #ccc;overflow-y:auto" contenteditable>\n					<br>\n					'+e+'\n				</div>\n				<i>PDF attached</i>\n				<div class="wrap">\n					<button email-send class="button right">SEND</button>\n					<button email-cancel class="button blue right" style="margin-right:5px">CANCEL</button>\n					<input class="email-password right" type="password" name="password" \n						style="height:37px;line-height:37px;width:25%;margin-right:5px" placeholder="Email Password" required />\n				</div>\n			</div>\n		</div>\n	'),$(".email-content").css({top:$(window).height()/2-$(".email-content").height()/2}),$(".email-content input[name=password]").val(n),o.run(function(){$(".email-content").animate({opacity:1},100)}),$(".email-content [email-send]").on("click",function(){$(".email-content .email-parent").addClass("no-click"),$(".email-content .email-parent").css("opacity","0.5"),$(".email-content .email-parent").append('\n			<div style="width:200px;height:123px;position:absolute;left:0;right:0;top:0;bottom:0;margin:auto;">\n				<img src="'+environment.root+'/css/media/plane.gif" width="200px" />\n			</div>\n		');var e,n,r=$(".email-email").val(),c=$(".email-subject").val(),l=$(".email-body").html(),p=$(".email-password").val();i.pdf($(i.s).find(i.form),function(t,i){e=t,n=i}),$.post(environment.root+"/post/email",{job_number:environment.job_number,name:e,html:n,client_name:environment.client_name,address:r,subject:c,body:l,password:p}).done(function(e){if("OK"==e)$(".email-content .email-parent").css("opacity","0"),$(".email-content").append('\n					<div style="width:95px;position:absolute;left:0;right:0;top:165px;margin:auto;">\n						<video autoplay>\n							<source src="'+environment.root+'/css/media/success.webm" type="video/webm">\n						</video>\n					</div>\n				'),setTimeout(function(){$(".email-content").fadeOut(100,function(){o.remove(function(){$(".email-content").off().unbind().remove(),i.refresh(t),i.update(t)})})},1500),localStorage.ep=p;else if("Password"==e){var n=void 0;n=a>1?'Do you need to <a href="'+environment.root+'/settings" target="_blank">update your password</a> in Paperwork?':"Wrong password",$(".email-content .email-parent").removeClass("no-click"),$(".email-content .email-parent").css("opacity","1"),$(".email-content .wait").remove(),$(".email-content [wrong-password]").remove(),$(".email-content .email-password").after('\n					<div wrong-password style="color:red;line-height:37px;padding-right:5px" class="right">\n						'+n+"\n					<div>\n				"),a++}else $(".email-content .email-parent").css("opacity","0"),$(".email-content").append('\n					<div style="text-align:center;position:absolute;left:0;right:0;top:78px;margin:auto;">\n						There was a problem sending this email.<br>\n						Please make sure your email settings are correct, otherwise email hello@paperwork.nz for support.\n					</div>\n				')}).fail(function(){$(".email-content .email-parent").css("opacity","0"),$(".email-content").append('\n				<div style="text-align:center;position:absolute;left:0;right:0;top:78px;margin:auto;">\n					There was a problem sending this email.<br>\n					Please make sure your email settings are correct, otherwise email hello@paperwork.nz for support.\n				</div>\n			')})}),$(".email-content [email-cancel]").on("click",function(){$(".email-content").fadeOut(100,function(){o.remove(function(){$(".email-content").off().unbind().remove(),i.refresh(t),i.update(t)})})}),r.on("click",function(){""==$(".email-subject").val()&&0===$(".email-body").html().length&&$(".email-content").fadeOut(100,function(){o.remove(function(){$(".email-content").off().unbind().remove(),i.refresh(t),i.update(t)})})})},Form.prototype.pdf=function(t,e){var n=this,i=(t.attr("data-formid"),$("."+n.tab.activeTab)),a=t.clone();a=n.strip(a);var o=(environment.job_number+"_"+i.attr("data-tab")+"-"+i.html().trim().toLowerCase()).trim(),r='\n	<!DOCTYPE html>\n	<html lang=\'en\'>\n	<head>\n		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">\n		<meta name=\'viewport\' content=\'width=device-width,initial-scale=1.0\'>\n	</head>\n	<body>\n	'+a+"\n	</body>\n	";e(o,r)},Form.prototype.post=function(t,e){var n=this;void 0!=t.url&&void 0!=t.template_id&&void 0!=t.client_id&&void 0!=t.job_id&&void 0!=t.job_number&&$.post(t.url,{template_id:t.template_id,client_id:t.client_id,job_id:t.job_id}).done(function(i){var i=JSON.parse(i),a=n.tab.objParent,o=Number($(a).find("["+n.tab.heir+"]").attr(n.tab.objhook)),r=i.id;$(a).find("["+n.tab.heir+"]").before("\n				<div "+n.tab.objhook+'="'+o+'" class="'+n.tab.obj+'" hidden>\n					'+i.html+"\n				</div>\n			"),$(a).find("["+n.tab.heir+"]").replaceWith("\n				<div "+n.tab.objhook+'="'+(o+1)+'" '+n.tab.heir+" hidden>\n				</div>\n			"),$("["+n.tab.objhook+'="'+o+'"]').find("[form-blob]").attr("data-formid",r);var c=$('[data-formid="'+r+'"]');n.crawl(c),n.tab.append(t.template_name,function(a){n.populate(c,{job_number:t.job_number,date:i.date,client:i.client}),n.put({url:environment.root+"/put/form",id:r},function(){n.construct(c),e(c)})})}).fail(function(){void 0!=e&&e(!1),console.log("Internal Server Error")})},Form.prototype.put=function(t,e){var n=this,i=$('[data-formid="'+t.id+'"]'),a=i.clone();n.p["do"]("flush-items",a);var o=n.strip(a);void 0!=t.url&&void 0!=t.id?$.post(t.url,{id:t.id,html:o,json:JSON.stringify(n.map[t.id])}).done(function(){"0"!=t?void 0!=e&&e(!0):(void 0!=e&&e(!1),console.log("Form put failed with Slim 0"))}).fail(function(){void 0!=e&&e(!1),console.log("Internal Server Error")}):console.log("URL or data.id not supplied, form not saved.")},Form.prototype["delete"]=function(t,e){void 0!=t.url&&void 0!=t.form_id&&$.post(t.url,{id:t.form_id}).done(function(t){"0"!=t?void 0!=e&&e(!0):(void 0!=e&&e(!1),console.log("Form delete failed with Slim 0"))}).fail(function(){void 0!=e&&e(!1),console.log("Internal Server Error")})};