"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol?"symbol":typeof t};Core.addBehavior("document",function(t,e){function n(){Paperwork.on("document.build",function(t){if("object"!==("undefined"==typeof t?"undefined":_typeof(t))||null===t)return console.warn("New document request not an object");for(var e in t)g[e]=t[e],o(e),m(e)}),Paperwork.on("document."+t.name+".reload",function(t){"object"===("undefined"==typeof t?"undefined":_typeof(t))&&null!==t&&(b=t),v.find('[data-type="document"]').each(function(){var t=$(this).data("id");o(t)})}),Paperwork.on("document."+t.name+".save",function(t){return x.toNumber(t)?void m(t,function(){Paperwork.send("notification")}):console.warn("Document ID not supplied")})}function a(){l="undefined"==typeof job?0:job.job_id,$.get(environment.root+"/get/inventory",function(t){$.get(environment.root+"/get/document/"+l,function(e){$.get(environment.root+"/get/template-properties",function(n){g=JSON.parse(e),b=JSON.parse(n),w.origin=JSON.parse(t);for(var a in w.origin)w.flat.push(w.origin[a].name);v.find('[data-type="document"]').each(function(){var t=$(this).data("id");o(t)})})})})}function o(t){var e=v.find('[data-type="document"][data-id="'+t+'"]'),n=e.find("[data-template]").data("template");$('[data-css="'+n+'"]').length<1&&$('<link data-css="'+n+'" type="text/css" rel="stylesheet">').appendTo("head").attr("href",environment.root+"/css/templates/"+n+".css"),g[t]&&null==g[t].items&&(g[t].items=[]),r(t),g[t]&&i(t),g[t]&&d(t),g[t]&&c(t),s(t),e.css("pointer-events","auto").animate({opacity:1},250)}function i(t){var e='[data-type="document"][data-id="'+t+'"]';v.find(e+' [data-type="inventory-input"]').html('\n			<input type="text" class="typeahead" placeholder="Item">\n		').find(".typeahead").typeahead({hint:!0,highlight:!0,minLength:1},{source:substringMatcher(w.flat)}),v.off("typeahead:select",e+" .tt-input"),v.on("typeahead:select",e+" .tt-input",function(){13!=event.which&&(u({document_id:t,name:$(this).val()}),s(t),$(this).typeahead("val",""),$(this).focus())}),v.off("keydown",e+" .tt-input"),v.on("keydown",e+" .tt-input",function(){13==event.which&&(u({document_id:t,name:$(this).val()}),s(t),$(this).typeahead("val",""),13==event.which&&event.preventDefault(),setTimeout(function(){v.find(e+" .typeahead").focus()},0))})}function r(t){var e='[data-type="document"][data-id="'+t+'"]';for(var n in b){var a=b[n],o=v.find(e+' [data-property="'+n+'"]');for(var i in g[t])-1!==a.indexOf("@"+i)&&(a=a.replace("@"+i,'<div data-aspect="'+i+'" style="display: inline;"></div>'));"background_colour"==n&&o.css("background-color",a||"white"),"text_colour"==n&&o.css("color",a||"white"),-1==n.indexOf("colour")&&o.html(a)}}function d(t){var e='[data-type="document"][data-id="'+t+'"]';v.off("keyup",e+" [data-aspect]"),v.on("keyup",e+" [data-aspect]",function(){var e,n=$(this).data("aspect");e=x.toText($(this)),g[t][n]=e.html().trim(),m(t)})}function c(t){var e='[data-type="document"][data-id="'+t+'"]',n=e+' [data-type="inventory-content"]';v.on("keydown",n+' [data-type="quantity"], '+n+' [data-type="price"]',function(){return 13==event.which?(event.preventDefault(),event.stopPropagation(),$(this).blur()):void 0}),v.off("blur",n+' [data-type="name"], '+n+' [data-type="quantity"], '+n+' [data-type="price"]'),v.on("blur",n+' [data-type="name"], '+n+' [data-type="quantity"], '+n+' [data-type="price"]',function(){var e,n,a=$(this).data("type"),o=$(this).closest(".inventory-item").index();e=x.toText($(this)),n=g[t].items[o][a],n!=e&&(g[t].items[o][a]=e.html().trim(),m(t),s(t),setTimeout(function(){N.end("[contenteditable]:hover")},0))}),v.off("click",n+' [data-type="remove"]'),v.on("click",n+' [data-type="remove"]',function(){var e=$(this).closest(".inventory-item").index();g[t].items.splice(e,1),m(t),s(t)})}function u(t){var e=t.document_id,n=t.name,a=void 0===n?"":n,o=t.quantity,r=void 0===o?"":o,d=t.price,c=void 0===d?"":d,u=t.margin,p=void 0===u?1:u,f=!1;for(var l in w.origin){var y=w.origin[l];if(y.name==[a]){c=y.price,f=!0;break}}"0.00"==c&&(c=""),g[e].items.push({name:a,quantity:r,price:c,margin:p}),m(e),!f&&a.length&&swal({html:!0,title:"Add "+a+" to your inventory?",text:"If you save this item you can use it again in future.",showCancelButton:!0,closeOnConfirm:!0,cancelButtonText:"No",confirmButtonText:"Yes"},function(t){t&&$.post(h.postInventory,{name:a,price:"0.00"}).done(function(t){t=JSON.parse(t),w.origin.push({name:a,price:"0.00"}),w.flat.push(a),i()})}),s(e)}function p(t){var e=(v.find('[data-type="document"][data-id="'+t+'"]'),0);for(var n in g[t].items){var a=g[t].items[n];a.hasOwnProperty("margin")||(a.margin=1);var o=x.toNumber(a.quantity,{decimal:2}),i=x.toNumber(a.price,{decimal:2}),r=x.toNumber(a.margin,{decimal:2}),d=void 0;d=o*(i*r),d=x.toNumber(d,{decimal:2}),d&&(e+=Number(d)),a.quantity=o,a.price=i,a.total=d,a.margin=r}g[t].subtotal=x.toNumber(e,{decimal:2}),g[t].tax=x.toNumber(g[t].subtotal/100*15,{decimal:2}),g[t].total=x.toNumber(g[t].subtotal+g[t].tax,{decimal:2})}function s(t){var e=g[t],n=v.find('[data-type="document"]').filter('[data-id="'+t+'"]');g[t]&&p(t);for(var a in e){var o=["subtotal","tax","total"],i=e[a];-1!=o.indexOf(a)&&(i=x.toDollar(i)),n.find('[data-aspect="'+a+'"]').html(i)}if(g[t]){n.find('[data-type="inventory-content"]').html("");for(var r in e.items){var d=e.items[r],c=d.margin,u=d.quantity,s=d.price,m=d.total;s&&(s*=c),u=x.toNumber(u,{decimal:2,natural:!0}),s=x.toDollar(s),m=x.toDollar(m),0===u&&(u="0.00"),"$0"===s&&(s="$0.00"),"$0"===m&&(m="$0.00"),u&&s||(m=""),n.find('[data-type="inventory-content"]').append('\n				<doc-section class="inventory-item wrap">\n					<doc-part class="inventory-item_name">\n						<doc-text data-type="name">\n							'+d.name+'\n						</doc-text>\n						<doc-part data-type="remove" class="remove-btn"></doc-part>\n					</doc-part>\n					<doc-part data-type="quantity" class="inventory-item_qty">\n						'+u+'\n					</doc-part>\n					<doc-part data-type="price" class="inventory-item_price">\n						'+s+'\n					</doc-part>\n					<doc-part data-type="item-total" class="inventory-item_total">\n						'+m+"\n					</doc-part>\n				</doc-section>\n			")}n.find('[data-aspect="name"], [data-aspect="date"], [data-aspect="reference"], [data-aspect="description"]').attr("contenteditable","true"),n.find('[data-type="inventory-content"] .inventory-item').find('[data-type="name"], [data-type="quantity"], [data-type="price"]').attr("contenteditable","true")}}function m(t,e){clearTimeout(y),y=setTimeout(function(){$.post(h.put,{id:t,document:g[t]}).done(function(t){e instanceof Function&&e()})},500)}function f(e){return e?x.toNumber(e)?g[e]:void console.warn("NaN provided while getting documents under context: "+t.name):g}var l,y,v=t.element,h={put:environment.root+"/put/document",postInventory:environment.root+"/post/inventory"},b=[],g=[],w={origin:{},flat:[]},x=t.require("parse"),N=t.require("caret");return n(),a(),{documents:f,properties:function(){return b}}});