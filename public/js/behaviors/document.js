"use strict";Core.addBehavior("document",function(t,e){function n(){$.get(environment.root+"/get/inventory",function(t){$.get(environment.root+"/get/document/"+job.job_id,function(e){$.get(environment.root+"/get/template-properties",function(n){v=JSON.parse(e),f=JSON.parse(n),h.origin=JSON.parse(t);for(var a in h.origin)h.flat.push(h.origin[a].name);y.find('[data-type="document"]').length>0&&i()})})})}function a(t){clearTimeout(m),m=setTimeout(function(){$.post(l.put,{id:t,document:v[t]})},500)}function i(){o(),d(),c(),r(),u(),y.find('[data-type="document"]').each(function(){var t=$(this).find("[data-template]").data("template"),e=$(this).data("id");$('[data-css="'+t+'"]').length<1&&$('<link data-css="'+t+'" type="text/css" rel="stylesheet">').appendTo("head").attr("href",environment.root+"/css/templates/"+t+".css"),null==v[e].items&&(v[e].items=[]),$(this).css("pointer-events","auto").animate({opacity:1},500)})}function o(){y.find('[data-type="document"] [data-type="inventory-input"]').html('\n			<input type="text" class="typeahead" placeholder="Item">\n		').find(".typeahead").typeahead({hint:!0,highlight:!0,minLength:1},{source:substringMatcher(h.flat)}),y.off("typeahead:select",'[data-type="document"] .tt-input'),y.on("typeahead:select",'[data-type="document"] .tt-input',function(){var t=$(this).closest('[data-type="document"]').data("id");13!=event.which&&(p({document_id:t,name:$(this).val()}),u(),$(this).typeahead("val",""))}),y.off("keydown",'[data-type="document"] .tt-input'),y.on("keydown",'[data-type="document"] .tt-input',function(){var t=$(this).closest('[data-type="document"]').data("id");13==event.which&&(p({document_id:t,name:$(this).val()}),u(),$(this).typeahead("val",""),13==event.which&&event.preventDefault())})}function d(){for(var t in f)y.find('[data-type="document"] [data-property="'+t+'"]').html(f[t])}function c(){y.off("keyup",'[data-type="document"] [data-aspect]'),y.on("keyup",'[data-type="document"] [data-aspect]',function(){var t=$(this).closest('[data-type="document"]').data("id"),e=$(this).data("aspect"),n=$(this).html().trim();v[t][e]=n,a(t)})}function r(){var t='[data-type="document"] [data-type="inventory-content"]';y.on("keydown",t+' [data-type="name"], '+t+' [data-type="quantity"], '+t+' [data-type="price"]',function(){return 13==event.which?(event.preventDefault(),event.stopPropagation(),$(this).blur()):void 0}),y.off("blur",t+' [data-type="name"], '+t+' [data-type="quantity"], '+t+' [data-type="price"]'),y.on("blur",t+' [data-type="name"], '+t+' [data-type="quantity"], '+t+' [data-type="price"]',function(){var t=$(this).closest('[data-type="document"]').data("id"),e=$(this).data("type"),n=$(this).closest(".inventory-item").index(),i=$(this).text().trim(),o=v[t].items[n][e];o!=i&&(v[t].items[n][e]=i,a(t),u())}),y.off("click",t+' [data-type="remove"]'),y.on("click",t+' [data-type="remove"]',function(){var t=$(this).closest('[data-type="document"]').data("id"),e=$(this).closest(".inventory-item").index();v[t].items.splice(e,1),a(t),u()})}function p(t){var e=t.document_id,n=t.name,i=void 0===n?"":n,d=t.quantity,c=void 0===d?"":d,r=t.price,p=void 0===r?"":r,s=!1;for(var m in h.origin){var y=h.origin[m];if(y.name==[i]){p=y.price,s=!0;break}}"0.00"==p&&(p=""),v[e].items.push({name:i,quantity:c,price:p}),a(e),!s&&i.length&&swal({html:!0,title:"Add "+i+" to your inventory?",text:"If you save this item you can use it again in future.",showCancelButton:!0,closeOnConfirm:!0,cancelButtonText:"No",confirmButtonText:"Yes"},function(t){t&&$.post(l.postInventory,{name:i,price:"0.00"}).done(function(t){t=JSON.parse(t),h.origin.push({name:i,price:"0.00"}),h.flat.push(i),o()})}),u()}function s(t){var e=(y.find('[data-type="document"]').filter('[data-id="'+t+'"]'),0);for(var n in v[t].items){var a=v[t].items[n],i=g.toNumber(a.quantity,{decimal:2}),o=g.toNumber(a.price,{decimal:2}),d=i*o;e+=d,a.quantity=i,a.price=g.toDollar(o),a.total=g.toDollar(d)}v[t]["sub-total"]=g.toDollar(e),v[t].tax=g.toDollar(e/100*15),v[t].total=g.toDollar(e+e/100*15)}function u(){for(var t in v){var e=v[t],n=y.find('[data-type="document"]').filter('[data-id="'+t+'"]');s(t);for(var a in e)n.find('[data-aspect="'+a+'"]').html(e[a]);n.find('[data-type="inventory-content"]').html("");for(var i in e.items){var o=e.items[i];n.find('[data-type="inventory-content"]').append('\n					<doc-section class="inventory-item">\n						<doc-part class="inventory-item_name">\n							<doc-text data-type="name">\n								'+o.name+'\n							</doc-text>\n							<doc-part data-type="remove" class="remove-btn"></doc-part>\n						</doc-part>\n						<doc-part class="inventory-item_qty">\n							<doc-text data-type="quantity">\n								'+o.quantity+'\n							</doc-text>\n						</doc-part>\n						<doc-part class="inventory-item_price">\n							<doc-text data-type="price">\n								'+o.price+'\n							</doc-text>\n						</doc-part>\n						<doc-part class="inventory-item_total">\n							<doc-text data-type="item-total">\n								'+o.total+"\n							</doc-text\n						</doc-part>\n					</doc-section>\n				")}}y.find('[data-type="document"]').find('[data-aspect="name"], [data-aspect="date"], [data-aspect="description"]').attr("contenteditable","true"),y.find('[data-type="document"] [data-type="inventory-content"] .inventory-item').find('[data-type="name"], [data-type="quantity"], [data-type="price"]').attr("contenteditable","true")}var m,y=t.element,l={put:environment.root+"/put/document",postInventory:environment.root+"/post/inventory"},f=[],v=[],h={origin:{},flat:[]},g=t.require("parse");n()});