"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol?"symbol":typeof t};Core.addBehavior("document",function(t,e){function n(){Paperwork.on("document."+t.name+".build",function(t){if("object"!==("undefined"==typeof t?"undefined":_typeof(t))||null===t)return console.warn("New document request not an object");for(var e in t)g[e]=t[e],o(e)}),Paperwork.on("document."+t.name+".reload",function(t){"object"===("undefined"==typeof t?"undefined":_typeof(t))&&null!==t&&(b=t),v.find('[data-type="document"]').each(function(){var t=$(this).data("id");o(t)})}),Paperwork.on("document."+t.name+".save",function(t){return x.toNumber(t)?(m(t),void Paperwork.send("notification")):console.warn("Document ID not supplied")})}function a(){y="undefined"==typeof job?0:job.job_id,$.get(environment.root+"/get/inventory",function(t){$.get(environment.root+"/get/document/"+y,function(e){$.get(environment.root+"/get/template-properties",function(n){g=JSON.parse(e),b=JSON.parse(n),w.origin=JSON.parse(t);for(var a in w.origin)w.flat.push(w.origin[a].name);v.find('[data-type="document"]').each(function(){var t=$(this).data("id");o(t)})})})})}function o(t){var e=v.find('[data-type="document"][data-id="'+t+'"]'),n=e.find("[data-template]").data("template");$('[data-css="'+n+'"]').length<1&&$('<link data-css="'+n+'" type="text/css" rel="stylesheet">').appendTo("head").attr("href",environment.root+"/css/templates/"+n+".css"),y&&null==g[t].items&&(g[t].items=[]),r(t),y&&i(t),y&&d(t),y&&c(t),s(t),e.css("pointer-events","auto").animate({opacity:1},500)}function i(t){var e='[data-type="document"][data-id="'+t+'"]';v.find(e+' [data-type="inventory-input"]').html('\n			<input type="text" class="typeahead" placeholder="Item">\n		').find(".typeahead").typeahead({hint:!0,highlight:!0,minLength:1},{source:substringMatcher(w.flat)}),v.off("typeahead:select",e+" .tt-input"),v.on("typeahead:select",e+" .tt-input",function(){13!=event.which&&(p({document_id:t,name:$(this).val()}),s(t),$(this).typeahead("val",""))}),v.off("keydown",e+" .tt-input"),v.on("keydown",e+" .tt-input",function(){13==event.which&&(p({document_id:t,name:$(this).val()}),s(t),$(this).typeahead("val",""),13==event.which&&event.preventDefault())})}function r(t){var e='[data-type="document"][data-id="'+t+'"]';for(var n in b){var a=b[n],o=v.find(e+' [data-property="'+n+'"]');"background_colour"==n&&o.css("background-color",a||"white"),"text_colour"==n&&o.css("color",a||"white"),-1==n.indexOf("colour")&&o.html(a)}}function d(t){var e='[data-type="document"][data-id="'+t+'"]';v.off("keyup",e+" [data-aspect]"),v.on("keyup",e+" [data-aspect]",function(){var e=$(this).data("aspect"),n=$(this).html().trim();g[t][e]=n,m(t)})}function c(t){var e='[data-type="document"][data-id="'+t+'"]',n=e+' [data-type="inventory-content"]';v.on("keydown",n+' [data-type="name"], '+n+' [data-type="quantity"], '+n+' [data-type="price"]',function(){return 13==event.which?(event.preventDefault(),event.stopPropagation(),$(this).blur()):void 0}),v.off("blur",n+' [data-type="name"], '+n+' [data-type="quantity"], '+n+' [data-type="price"]'),v.on("blur",n+' [data-type="name"], '+n+' [data-type="quantity"], '+n+' [data-type="price"]',function(){var e=$(this).data("type"),n=$(this).closest(".inventory-item").index(),a=$(this).text().trim(),o=g[t].items[n][e];o!=a&&(g[t].items[n][e]=a,m(t),s(t))}),v.off("click",n+' [data-type="remove"]'),v.on("click",n+' [data-type="remove"]',function(){var e=$(this).closest(".inventory-item").index();g[t].items.splice(e,1),m(t),s(t)})}function p(t){var e=t.document_id,n=t.name,a=void 0===n?"":n,o=t.quantity,r=void 0===o?"":o,d=t.price,c=void 0===d?"":d,p=!1;for(var u in w.origin){var f=w.origin[u];if(f.name==[a]){c=f.price,p=!0;break}}"0.00"==c&&(c=""),g[e].items.push({name:a,quantity:r,price:c}),m(e),!p&&a.length&&swal({html:!0,title:"Add "+a+" to your inventory?",text:"If you save this item you can use it again in future.",showCancelButton:!0,closeOnConfirm:!0,cancelButtonText:"No",confirmButtonText:"Yes"},function(t){t&&$.post(h.postInventory,{name:a,price:"0.00"}).done(function(t){t=JSON.parse(t),w.origin.push({name:a,price:"0.00"}),w.flat.push(a),i()})}),s(e)}function u(t){var e=(v.find('[data-type="document"][data-id="'+t+'"]'),0);for(var n in g[t].items){var a=g[t].items[n],o=x.toNumber(a.quantity,{decimal:2}),i=x.toNumber(a.price,{decimal:2}),r=o*i;e+=r,a.quantity=o,a.price=x.toDollar(i),a.total=x.toDollar(r)}g[t]["sub-total"]=x.toDollar(e),g[t].tax=x.toDollar(e/100*15),g[t].total=x.toDollar(e+e/100*15)}function s(t){var e=g[t],n=v.find('[data-type="document"]').filter('[data-id="'+t+'"]');y&&u(t);for(var a in e)n.find('[data-aspect="'+a+'"]').html(e[a]);if(y){n.find('[data-type="inventory-content"]').html("");for(var o in e.items){var i=e.items[o];n.find('[data-type="inventory-content"]').append('\n				<doc-section class="inventory-item">\n					<doc-part class="inventory-item_name">\n						<doc-text data-type="name">\n							'+i.name+'\n						</doc-text>\n						<doc-part data-type="remove" class="remove-btn"></doc-part>\n					</doc-part>\n					<doc-part class="inventory-item_qty">\n						<doc-text data-type="quantity">\n							'+i.quantity+'\n						</doc-text>\n					</doc-part>\n					<doc-part class="inventory-item_price">\n						<doc-text data-type="price">\n							'+i.price+'\n						</doc-text>\n					</doc-part>\n					<doc-part class="inventory-item_total">\n						<doc-text data-type="item-total">\n							'+i.total+"\n						</doc-text\n					</doc-part>\n				</doc-section>\n			")}n.find('[data-aspect="name"], [data-aspect="date"], [data-aspect="description"]').attr("contenteditable","true"),n.find('[data-type="inventory-content"] .inventory-item').find('[data-type="name"], [data-type="quantity"], [data-type="price"]').attr("contenteditable","true")}}function m(t){clearTimeout(l),l=setTimeout(function(){$.post(h.put,{id:t,document:g[t]})},500)}function f(e){return e?x.toNumber(e)?g[e]:void console.warn("NaN provided while getting documents under context: "+t.name):g}var y,l,v=t.element,h={put:environment.root+"/put/document",postInventory:environment.root+"/post/inventory"},b=[],g=[],w={origin:{},flat:[]},x=t.require("parse");return n(),a(),{documents:f,properties:function(){return b}}});