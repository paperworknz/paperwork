"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol?"symbol":typeof t};Core.addBehavior("document",function(t,e){function n(){Paperwork.on("document.build",function(t){if("object"!==("undefined"==typeof t?"undefined":_typeof(t))||null===t)return console.warn("New document request not an object");for(var e in t)x[e]=t[e],o(e),l(e)}),Paperwork.on("document."+t.name+".reload",function(t){"object"===("undefined"==typeof t?"undefined":_typeof(t))&&null!==t&&(g=t),h.find('[data-type="document"]').each(function(){var t=$(this).data("id");o(t),l(i)})}),Paperwork.on("document."+t.name+".save",function(t){return N.toNumber(t)?(l(t),void Paperwork.send("notification")):console.warn("Document ID not supplied")})}function a(){y="undefined"==typeof job?0:job.job_id,$.get(environment.root+"/get/inventory",function(t){$.get(environment.root+"/get/document/"+y,function(e){$.get(environment.root+"/get/template-properties",function(n){x=JSON.parse(e),g=JSON.parse(n),w.origin=JSON.parse(t);for(var a in w.origin)w.flat.push(w.origin[a].name);h.find('[data-type="document"]').each(function(){var t=$(this).data("id");o(t)})})})})}function o(t){var e=h.find('[data-type="document"][data-id="'+t+'"]'),n=e.find("[data-template]").data("template");$('[data-css="'+n+'"]').length<1&&$('<link data-css="'+n+'" type="text/css" rel="stylesheet">').appendTo("head").attr("href",environment.root+"/css/templates/"+n+".css"),y&&null==x[t].items&&(x[t].items=[]),d(t),y&&r(t),y&&c(t),y&&u(t),s(t),e.css("pointer-events","auto").animate({opacity:1},500)}function r(t){var e='[data-type="document"][data-id="'+t+'"]';h.find(e+' [data-type="inventory-input"]').html('\n			<input type="text" class="typeahead" placeholder="Item">\n		').find(".typeahead").typeahead({hint:!0,highlight:!0,minLength:1},{source:substringMatcher(w.flat)}),h.off("typeahead:select",e+" .tt-input"),h.on("typeahead:select",e+" .tt-input",function(){13!=event.which&&(p({document_id:t,name:$(this).val()}),s(t),$(this).typeahead("val",""))}),h.off("keydown",e+" .tt-input"),h.on("keydown",e+" .tt-input",function(){13==event.which&&(p({document_id:t,name:$(this).val()}),s(t),$(this).typeahead("val",""),13==event.which&&event.preventDefault())})}function d(t){var e='[data-type="document"][data-id="'+t+'"]';for(var n in g){var a=g[n],o=h.find(e+' [data-property="'+n+'"]');"background_colour"==n&&o.css("background-color",a||"white"),"text_colour"==n&&o.css("color",a||"white"),-1==n.indexOf("colour")&&o.html(a)}}function c(t){var e='[data-type="document"][data-id="'+t+'"]';h.off("keyup",e+" [data-aspect]"),h.on("keyup",e+" [data-aspect]",function(){var e=$(this).data("aspect"),n=$(this).html().trim();x[t][e]=n,l(t)})}function u(t){var e='[data-type="document"][data-id="'+t+'"]',n=e+' [data-type="inventory-content"]';h.on("keydown",n+' [data-type="name"], '+n+' [data-type="quantity"], '+n+' [data-type="price"]',function(){return 13==event.which?(event.preventDefault(),event.stopPropagation(),$(this).blur()):void 0}),h.off("blur",n+' [data-type="name"], '+n+' [data-type="quantity"], '+n+' [data-type="price"]'),h.on("blur",n+' [data-type="name"], '+n+' [data-type="quantity"], '+n+' [data-type="price"]',function(){var e=$(this).data("type"),n=$(this).closest(".inventory-item").index(),a=$(this).text().trim(),o=x[t].items[n][e];o!==a&&(x[t].items[n][e]=a,l(t),s(t))}),h.off("click",n+' [data-type="remove"]'),h.on("click",n+' [data-type="remove"]',function(){var e=$(this).closest(".inventory-item").index();x[t].items.splice(e,1),l(t),s(t)})}function p(t){var e=t.document_id,n=t.name,a=void 0===n?"":n,o=t.quantity,i=void 0===o?"":o,d=t.price,c=void 0===d?"":d,u=t.margin,p=void 0===u?1:u,m=!1;for(var f in w.origin){var y=w.origin[f];if(y.name==[a]){c=y.price,m=!0;break}}"0.00"==c&&(c=""),x[e].items.push({name:a,quantity:i,price:c,margin:p}),l(e),!m&&a.length&&swal({html:!0,title:"Add "+a+" to your inventory?",text:"If you save this item you can use it again in future.",showCancelButton:!0,closeOnConfirm:!0,cancelButtonText:"No",confirmButtonText:"Yes"},function(t){t&&$.post(b.postInventory,{name:a,price:"0.00"}).done(function(t){t=JSON.parse(t),w.origin.push({name:a,price:"0.00"}),w.flat.push(a),r()})}),s(e)}function m(t){var e=(h.find('[data-type="document"][data-id="'+t+'"]'),0);for(var n in x[t].items){var a=x[t].items[n];a.hasOwnProperty("margin")||(a.margin=1);var o=N.toNumber(a.quantity,{decimal:2}),i=N.toNumber(a.price,{decimal:2}),r=N.toNumber(a.margin,{decimal:2}),d=void 0;d=o*(i*r),d=N.toNumber(d,{decimal:2}),d&&(e+=Number(d)),a.quantity=o,a.price=i,a.total=d,a.margin=r}x[t].subtotal=N.toNumber(e,{decimal:2}),x[t].tax=N.toNumber(x[t].subtotal/100*15,{decimal:2}),x[t].total=N.toNumber(x[t].subtotal+x[t].tax,{decimal:2})}function s(t){var e=x[t],n=h.find('[data-type="document"]').filter('[data-id="'+t+'"]');y&&m(t);for(var a in e){var o=["subtotal","tax","total"],i=e[a];-1!=o.indexOf(a)&&(i=N.toDollar(i)),n.find('[data-aspect="'+a+'"]').html(i)}if(y){n.find('[data-type="inventory-content"]').html("");for(var r in e.items){var d=e.items[r],c=d.margin,u=d.quantity,p=d.price,s=d.total;p&&(p*=c),u=N.toNumber(u,{decimal:2,natural:!0}),p=N.toDollar(p),s=N.toDollar(s),0===u&&(u="0.00"),"$0"===p&&(p="$0.00"),"$0"===s&&(s="$0.00"),u&&p||(s=""),n.find('[data-type="inventory-content"]').append('\n				<doc-section class="inventory-item">\n					<doc-part class="inventory-item_name">\n						<doc-text data-type="name">\n							'+d.name+'\n						</doc-text>\n						<doc-part data-type="remove" class="remove-btn"></doc-part>\n					</doc-part>\n					<doc-part class="inventory-item_qty">\n						<doc-text data-type="quantity">\n							'+u+'\n						</doc-text>\n					</doc-part>\n					<doc-part class="inventory-item_price">\n						<doc-text data-type="price">\n							'+p+'\n						</doc-text>\n					</doc-part>\n					<doc-part class="inventory-item_total">\n						<doc-text data-type="item-total">\n							'+s+"\n						</doc-text\n					</doc-part>\n				</doc-section>\n			")}n.find('[data-aspect="name"], [data-aspect="date"], [data-aspect="description"]').attr("contenteditable","true"),n.find('[data-type="inventory-content"] .inventory-item').find('[data-type="name"], [data-type="quantity"], [data-type="price"]').attr("contenteditable","true")}}function l(t){clearTimeout(v),v=setTimeout(function(){$.post(b.put,{id:t,document:x[t]})},500)}function f(e){return e?N.toNumber(e)?x[e]:void console.warn("NaN provided while getting documents under context: "+t.name):x}var y,v,h=t.element,b={put:environment.root+"/put/document",postInventory:environment.root+"/post/inventory"},g=[],x=[],w={origin:{},flat:[]},N=t.require("parse");return n(),a(),{documents:f,properties:function(){return g}}});