"use strict";Core.addModule("job",function(o){function t(){l=new Form,i(),n()}function n(){r(),d(),e(),a(),f()}function i(){Paperwork.wait(s.find(".pdf-load")),$.get(u.form.getPDFList).done(function(o){if("0"==o)return void s.find(".pdf-load").closest("tr").remove();o=JSON.parse(o),s.find(".pdf-load").remove(),s.find(".pdf-title").html("Paper");for(var t in o){var n=o[t];s.find(".pdf-list").append('\n					<div style="height:24px;line-height:24px">\n						<a target="_blank" href="'+environment.root+"/get/pdf/"+job.job_number+"/"+n+'">'+n+"</a>\n					</div>\n				")}})}function e(){s.on("change",".status",function(){void 0!=$(this).val()&&$.post(u.job.putDetails,{id:job.job_id,status:$(this).val()}).done(function(o){return"0"==o?Paperwork.send("notification","Failed to save"):(Paperwork.send("notification","Saved"),void("Completed"==o&&Paperwork["goto"](environment.root+"/"+environment.page)))})})}function r(){s.find(".job-name").change(function(){""!=$(".job-name").val()&&$.post(u.job.putDetails,{name:$(".job-name").val(),id:job.job_id}).done(function(){Paperwork.send("notification","Saved")})})}function d(){s.on("click",".button.delete",function(){var o=$(this);swal({title:"Are you sure you want to delete this job?",text:"Deleting this job will delete ALL quotes and invoices attached",showCancelButton:!0,closeOnConfirm:!0},function(t){return t?void s.find("[job-del-form]").submit():Paperwork.ready(o,"Delete Job")})})}function a(){var o=s.find(".notepad").html();s.find(".note-wrap").on("click",function(){s.find(".notepad").focus()}),s.find(".notepad").on("blur",function(){$(this).html()!=o&&$.post(u.job.putDetails,{notes:$(this).html(),id:job.job_id}).done(function(){o=s.find(".notepad").html(),Paperwork.send("notification","Notes saved")})})}function f(){var o;s.on("click","[new-template]",function(){var o=$(this),t=$(this).html();Paperwork.wait(o),l.post({url:u.form.post,template_name:t,template_id:o.attr("data-templateid"),client_id:job.client_id,job_id:job.job_id,job_number:job.job_number},function(n){n&&(Paperwork.ready(o,t),s.find(l.s).find("[form-blob]").removeClass("form-loading"),s.find(l.s).find(".tt-input").focus())})}),s.on("click","[form-save-btn]",function(){var o=$(this);l.put({url:u.form.put,id:s.find(l.s).find("[form-blob]").attr("data-formid")},function(t){return t?(Paperwork.ready(o,"SAVE"),void Paperwork.send("notification","Saved")):(Paperwork.ready(o,"SAVE"),void Paperwork.saved("Failed to save"))})}),s.on("click","[form-del-btn]",function(){var o=$(this);s.find(l.s+" "+l.form).addClass("form-loading"),swal({title:"Are you sure you want to delete this?",text:"Deleting this will remove it forever",showCancelButton:!0,closeOnConfirm:!0},function(t){return t?void l["delete"]({url:u.form["delete"],form_id:s.find(l.s).find("[form-blob]").attr("data-formid")},function(){var o=s.find(".notes").position(),t=s.find(".notes").clone(),n=s.find('[data-type="tab-container"] .active').data("id");s.find(".notes").css({position:"absolute",top:o.top,left:o.left}),s.find(l.s).slideUp("fast",function(){s.find(l.s).remove(),s.find('[data-type="tab-container"] [data-id="'+n+'"]').fadeOut("fast",function(){Paperwork.send("tab.job.activate",s.find('[data-type="tab-container"] [data-id="'+n+'"]').prev().data("id")),s.find(".notes").replaceWith(t),s.find(".note-wrap").on("click",function(){s.find(".notepad").focus()}),$(this).remove()})})}):Paperwork.ready(o,"DELETE")})}),s.on("click","[form-pdf-btn]",function(){var o=$(this),t=o.html();l.put({url:u.form.put,id:s.find(l.s).find("[form-blob]").attr("data-formid")},function(n){return n?void l.pdf(s.find(l.s).find("[form-blob]"),function(o,t){s.find(l.s).find("[form-pdf-name]").val(o),s.find(l.s).find("[form-pdf-html]").val(t),s.find(l.s).find("[form-pdf-form]").submit(),window.onfocus=function(){Paperwork.ready(s.find("[form-pdf-btn]"),"PDF")}}):(Paperwork.ready(o,t),Paperwork.send("notification","Error making PDF"))})}),s.on("click","[form-copy-btn]",function(){l.copy(s.find(l.s+" [form-blob]"),templates)}),s.on("click","[form-margin-btn]",function(){l.margin(s.find(l.s+" [form-blob]"))}),s.on("click","[form-email-btn]",function(){l.email(s.find(l.s+" [form-blob]"))}),s.on("keyup","[form-blob] [contenteditable]",function(){clearTimeout(o),o=setTimeout(function(){l.put({url:u.form.put,id:s.find(l.s).find("[form-blob]").attr("data-formid")})},2e3)})}var s=o.element;o.use("tab");var l,u={job:{putDetails:environment.root+"/put/job-details"},form:{getPDFList:environment.root+"/get/pdf-json/"+job.job_id,post:environment.root+"/post/form",put:environment.root+"/put/form","delete":environment.root+"/delete/form"}};t()});